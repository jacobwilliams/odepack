<!-- -*- mode: jinja2 -*- -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="ODEPACK - A Systematized Collection of ODE Solvers">
    <meta name="author" content="Alan C. Hindmarsh as modified by John S. Urban, Jacob Williams" >
    <link rel="icon" href="../favicon.png">

    <title>dstoda &ndash; odepack</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
      <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
      <link href="../css/user.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>
  </head>

  <body>

    <!-- Fixed navbar -->
    <div class="container-fluid mb-sm-4 mb-xl-2">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
          <a class="navbar-brand" href="../index.html">odepack </a>
          <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar"
                  aria-expanded="false" aria-controls="navbar" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon">
          </button>

          <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav">
                  <li class="nav-item">
                    <a class="nav-link" href="../lists/files.html">Source Files</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/modules.html">Modules</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/procedures.html">Procedures</a>
                </li>
            </ul>
              <div class="d-flex align-items-end flex-grow-1">
                <form action="../search.html" role="search" class="ms-auto">
                  <input type="text" class="form-control" aria-label="Search" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
                </form>
              </div>
          </div><!--/.nav-collapse -->
        </div>
      </nav>
    </div>

    <div class="container">
  <div class="row">
    <h1>dstoda
      <small>Subroutine</small>
      
    </h1>
      <div class="container p-2 mb-4 bg-light border rounded-3">
    <div class="row align-items-center justify-content-between" id="info-bar">
      <div class="col">
        <ul class="list-inline" style="margin-bottom:0px;display:inline">

            <li class="list-inline-item" id="statements"><i class="fa fa-list-ol"></i>
              <a data-bs-toggle="tooltip"
                 data-bs-placement="bottom" data-html="true"
                 title=" 1.9% of total for procedures.">444 statements</a>
            </li>

            <li class="list-inline-item" id="source-file">
              <i class="fa fa-code"></i>
              <a href="../src/dstoda.inc"> Source File</a>
            </li>
        </ul>
      </div>
      <div class="col">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb justify-content-end mb-0">
                <li class="breadcrumb-item"><a href='../sourcefile/dstoda.inc.html'>dstoda.inc</a></li>
            <li class="breadcrumb-item active" aria-current="page">dstoda</li>
          </ol>
        </nav>
      </div>
    </div>
  </div>
  <script>
    $(function () {
    $('[data-bs-toggle="tooltip"]').tooltip()
    })
  </script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
      <div id="sidebar">
      <h3>Contents</h3>
  
      <div class="card mb-4">
      <a data-bs-toggle="collapse" href="#vars-0"
         aria-expanded="false" aria-controls="vars-0">
         <h4 class="card-header bg-primary text-white">Variables</h4>
      </a>
      <div id="vars-0" class="collapse">
        <div class="list-group list-group-flush">
            <a class="list-group-item" href="../proc/dstoda.html#variable-alpha">alpha</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-dcon~3">dcon</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-ddn~3">ddn</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-del~3">del</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-delp~3">delp</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-dm1">dm1</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-dm2">dm2</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-dsm~3">dsm</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-dup~3">dup</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-exdn~3">exdn</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-exm1">exm1</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-exm2">exm2</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-exsm~3">exsm</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-exup~3">exup</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-i~43">i</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-i1~15">i1</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-iredo~3">iredo</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-iret~3">iret</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-j~24">j</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-jb~4">jb</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-lm1~2">lm1</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-lm1p1">lm1p1</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-lm2">lm2</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-lm2p1">lm2p1</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-m~6">m</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-ncf~3">ncf</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-newq~3">newq</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-nqm1~2">nqm1</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-nqm2">nqm2</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-pdh">pdh</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-pnorm">pnorm</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-r~11">r</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-rate">rate</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-rh~11">rh</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-rh1">rh1</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-rh1it">rh1it</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-rh2">rh2</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-rhdn~3">rhdn</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-rhsm~3">rhsm</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-rhup~3">rhup</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-rm">rm</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-sm1">sm1</a>
            <a class="list-group-item" href="../proc/dstoda.html#variable-told~3">told</a>
        </div>
      </div>
    </div>

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    <div class="card card-primary">
      <div class="card-header text-left"><h3 class="card-title">Source Code</h3></div>
      <div class="list-group">
        <a class="list-group-item" href="../proc/dstoda.html#src">dstoda</a>
      </div>
    </div>


  </div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2> subroutine dstoda(Neq, Y, Yh, Nyh, Yh1, Ewt, Savf, Acor, Wm, Iwm, f, jac, pjac, slvs)  
</h2>
    

    <p>DSTODA performs one step of the integration of an initial value
problem for a system of ordinary differential equations.</p>
<p>Note: DSTODA is independent of the value of the iteration method
indicator MITER, when this is .ne. 0, and hence is independent
of the type of chord method used, or the Jacobian structure.</p>
<p>Communication with DSTODA is done with the following variables:</p>
<dl>
<dt>Y</dt>
<dd>
<p>an array of length .ge. N used as the Y argument in
all calls to F and JAC.</p>
</dd>
<dt>NEQ</dt>
<dd>
<p>integer array containing problem size in NEQ(1), and
passed as the NEQ argument in all calls to F and JAC.</p>
</dd>
<dt>YH</dt>
<dd>
<p>an NYH by LMAX array containing the dependent variables
and their approximate scaled derivatives, where
LMAX = MAXORD + 1.  YH(i,j+1) contains the approximate
j-th derivative of y(i), scaled by H**j/factorial(j)
(j = 0,1,&hellip;,NQ).  On entry for the first step, the first
two columns of YH must be set from the initial values.</p>
</dd>
<dt>NYH</dt>
<dd>
<p>a constant integer .ge. N, the first dimension of YH.</p>
</dd>
<dt>YH1</dt>
<dd>
<p>a one-dimensional array occupying the same space as YH.</p>
</dd>
<dt>EWT</dt>
<dd>
<p>an array of length N containing multiplicative weights
for local error measurements.  Local errors in y(i) are
compared to 1.0/EWT(i) in various error tests.</p>
</dd>
<dt>SAVF</dt>
<dd>
<p>an array of working storage, of length N.</p>
</dd>
<dt>ACOR</dt>
<dd>
<p>a work array of length N, used for the accumulated
corrections.  On a successful return, ACOR(i) contains
the estimated one-step local error in y(i).</p>
</dd>
<dt>WM,IWM</dt>
<dd>
<p>real and integer work arrays associated with matrix
operations in chord iteration (MITER .ne. 0).</p>
</dd>
<dt>PJAC</dt>
<dd>
<p>name of routine to evaluate and preprocess Jacobian matrix
and P = I - H<em>EL0</em>Jac, if a chord method is being used.
It also returns an estimate of norm(Jac) in PDNORM.</p>
</dd>
<dt>SLVS</dt>
<dd>
<p>name of routine to solve linear system in chord iteration.</p>
</dd>
<dt>CCMAX</dt>
<dd>
<p>maximum relative change in H*EL0 before PJAC is called.</p>
</dd>
<dt>H</dt>
<dd>
<p>the step size to be attempted on the next step.
H is altered by the error control algorithm during the
problem.  H can be either positive or negative, but its
sign must remain constant throughout the problem.</p>
</dd>
<dt>HMIN</dt>
<dd>
<p>the minimum absolute value of the step size H to be used.</p>
</dd>
<dt>HMXI</dt>
<dd>
<p>inverse of the maximum absolute value of H to be used.
HMXI = 0.0 is allowed and corresponds to an infinite HMAX.
HMIN and HMXI may be changed at any time, but will not
take effect until the next change of H is considered.</p>
</dd>
<dt>TN</dt>
<dd>
<p>the independent variable. TN is updated on each step taken.</p>
</dd>
<dt>JSTART</dt>
<dd>
<p>an integer used for input only, with the following
values and meanings:
              0  perform the first step.
          .gt.0  take a new step continuing from the last.
             -1  take the next step with a new value of H,
                   N, METH, MITER, and/or matrix parameters.
             -2  take the next step with a new value of H,
                   but with other inputs unchanged.
         On return, JSTART is set to 1 to facilitate continuation.</p>
</dd>
<dt>KFLAG</dt>
<dd>
<p>a completion code with the following meanings:
          0  the step was succesful.
         -1  the requested error could not be achieved.
         -2  corrector convergence could not be achieved.
         -3  fatal error in PJAC or SLVS.</p>
</dd>
</dl>
<p>A return with KFLAG = -1 or -2 means either
ABS(H) = HMIN or 10 consecutive failures occurred.
On a return with KFLAG negative, the values of TN and
the YH array are as of the beginning of the last
step, and H is the last step size attempted.</p>
<dl>
<dt>MAXORD</dt>
<dd>
<p>the maximum order of integration method to be allowed.</p>
</dd>
<dt>MAXCOR</dt>
<dd>
<p>the maximum number of corrector iterations allowed.</p>
</dd>
<dt>MSBP</dt>
<dd>
<p>maximum number of steps between PJAC calls (MITER .gt. 0).</p>
</dd>
<dt>MXNCF</dt>
<dd>
<p>maximum number of convergence failures allowed.</p>
</dd>
<dt>METH</dt>
<dd>
<p>current method.
     METH = 1 means Adams method (nonstiff)
     METH = 2 means BDF method (stiff)
     METH may be reset by DSTODA.</p>
</dd>
<dt>MITER</dt>
<dd>
<p>corrector iteration method.
MITER = 0 means functional iteration.
MITER = JT .gt. 0 means a chord iteration corresponding
to Jacobian type JT.  (The DLSODA/DLSODAR argument JT is
communicated here as JTYP, but is not used in DSTODA
except to load MITER following a method switch.)
MITER may be reset by DSTODA.</p>
</dd>
<dt>N</dt>
<dd>
<p>the number of first-order differential equations.</p>
</dd>
</dl>


    <h3>Arguments</h3>
        <table class="table table-striped varlist">
    <thead>
      <tr>
        <th scope="col">Type</th>
<th scope="col">Intent</th><th scope="col">Optional</th>        <th scope="col">Attributes</th>
        <th scope="col"></th>
        <th scope="col">Name</th>
        <th scope="col"></th>
    </thead>
    <tbody>
        <tr>
            <td>
              <span class="anchor" id="variable-neq~30"></span>
              integer
            </td>
<td></td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>Neq</strong>(*)</td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-y~30"></span>
              real(kind=dp),
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>Y</strong>(*)</td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-yh~10"></span>
              real(kind=dp),
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>Yh</strong>(Nyh,*)</td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-nyh~10"></span>
              integer
            </td>
<td></td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>Nyh</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-yh1~3"></span>
              real(kind=dp),
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>Yh1</strong>(*)</td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-ewt~13"></span>
              real(kind=dp)
            </td>
<td></td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>Ewt</strong>(*)</td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-savf~14"></span>
              real(kind=dp),
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>Savf</strong>(*)</td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-acor~3"></span>
              real(kind=dp),
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>Acor</strong>(*)</td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-wm~12"></span>
              real(kind=dp)
            </td>
<td></td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>Wm</strong>(*)</td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-iwm~12"></span>
              integer
            </td>
<td></td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>Iwm</strong>(*)</td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-f~19"></span>
              real
            </td>
<td></td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>f</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-jac~21"></span>
              integer
            </td>
<td></td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>jac</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-pjac~2"></span>
              real
            </td>
<td></td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>pjac</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-slvs~2"></span>
              real
            </td>
<td></td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>slvs</strong></td>
            <td>
                
            </td>
        </tr>
    </tbody>
  </table>

    <br>
    <div class="card">
      <div class="card-header">
  <h3 class="card-title">Calls</h3>
      </div>
      <div class="card-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: proc~~dstoda~~CallsGraph Pages: 1 -->
<svg id="procdstodaCallsGraph" width="213pt" height="284pt"
 viewBox="0.00 0.00 213.00 284.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~dstoda~~CallsGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 280)">
<title>proc~~dstoda~~CallsGraph</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-280 209,-280 209,4 -4,4"/>
<!-- proc~dstoda -->
<g id="proc~~dstoda~~CallsGraph_node1" class="node">
<title>proc~dstoda</title>
<polygon fill="none" stroke="black" points="111,-150 0,-150 0,-126 111,-126 111,-150"/>
<text text-anchor="middle" x="55.5" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50">dstoda.inc::dstoda</text>
</g>
<!-- cm1 -->
<g id="proc~~dstoda~~CallsGraph_node2" class="node">
<title>cm1</title>
<polygon fill="#777777" stroke="#777777" points="203,-276 149,-276 149,-252 203,-252 203,-276"/>
<text text-anchor="middle" x="176" y="-261.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cm1</text>
</g>
<!-- proc~dstoda&#45;&gt;cm1 -->
<g id="proc~~dstoda~~CallsGraph_edge1" class="edge">
<title>proc~dstoda&#45;&gt;cm1</title>
<path fill="none" stroke="#000000" d="M65.51,-150.08C80.98,-170.41 114.12,-212.28 147,-243 147.92,-243.86 148.88,-244.73 149.86,-245.58"/>
<polygon fill="#000000" stroke="#000000" points="147.68,-248.31 157.65,-251.9 152.09,-242.88 147.68,-248.31"/>
</g>
<!-- cm2 -->
<g id="proc~~dstoda~~CallsGraph_node3" class="node">
<title>cm2</title>
<polygon fill="#777777" stroke="#777777" points="203,-234 149,-234 149,-210 203,-210 203,-234"/>
<text text-anchor="middle" x="176" y="-219.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cm2</text>
</g>
<!-- proc~dstoda&#45;&gt;cm2 -->
<g id="proc~~dstoda~~CallsGraph_edge2" class="edge">
<title>proc~dstoda&#45;&gt;cm2</title>
<path fill="none" stroke="#000000" d="M73.48,-150.04C93.45,-164.19 126.8,-187.84 149.8,-204.13"/>
<polygon fill="#000000" stroke="#000000" points="147.87,-207.06 158.05,-209.99 151.92,-201.35 147.87,-207.06"/>
</g>
<!-- dcfode -->
<g id="proc~~dstoda~~CallsGraph_node4" class="node">
<title>dcfode</title>
<polygon fill="#777777" stroke="#777777" points="203,-192 149,-192 149,-168 203,-168 203,-192"/>
<text text-anchor="middle" x="176" y="-177.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dcfode</text>
</g>
<!-- proc~dstoda&#45;&gt;dcfode -->
<g id="proc~~dstoda~~CallsGraph_edge3" class="edge">
<title>proc~dstoda&#45;&gt;dcfode</title>
<path fill="none" stroke="#000000" d="M90.46,-150.04C105.72,-155.44 123.73,-161.83 139.2,-167.31"/>
<polygon fill="#000000" stroke="#000000" points="138.35,-170.72 148.95,-170.77 140.69,-164.13 138.35,-170.72"/>
</g>
<!-- dmnorm -->
<g id="proc~~dstoda~~CallsGraph_node5" class="node">
<title>dmnorm</title>
<polygon fill="#777777" stroke="#777777" points="205,-150 147,-150 147,-126 205,-126 205,-150"/>
<text text-anchor="middle" x="176" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dmnorm</text>
</g>
<!-- proc~dstoda&#45;&gt;dmnorm -->
<g id="proc~~dstoda~~CallsGraph_edge4" class="edge">
<title>proc~dstoda&#45;&gt;dmnorm</title>
<path fill="none" stroke="#000000" d="M111.24,-138C119.84,-138 128.57,-138 136.7,-138"/>
<polygon fill="#000000" stroke="#000000" points="136.97,-141.5 146.97,-138 136.97,-134.5 136.97,-141.5"/>
</g>
<!-- el -->
<g id="proc~~dstoda~~CallsGraph_node6" class="node">
<title>el</title>
<polygon fill="#777777" stroke="#777777" points="203,-108 149,-108 149,-84 203,-84 203,-108"/>
<text text-anchor="middle" x="176" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">el</text>
</g>
<!-- proc~dstoda&#45;&gt;el -->
<g id="proc~~dstoda~~CallsGraph_edge5" class="edge">
<title>proc~dstoda&#45;&gt;el</title>
<path fill="none" stroke="#000000" d="M90.46,-125.96C105.72,-120.56 123.73,-114.17 139.2,-108.69"/>
<polygon fill="#000000" stroke="#000000" points="140.69,-111.87 148.95,-105.23 138.35,-105.28 140.69,-111.87"/>
</g>
<!-- elco -->
<g id="proc~~dstoda~~CallsGraph_node7" class="node">
<title>elco</title>
<polygon fill="#777777" stroke="#777777" points="203,-66 149,-66 149,-42 203,-42 203,-66"/>
<text text-anchor="middle" x="176" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">elco</text>
</g>
<!-- proc~dstoda&#45;&gt;elco -->
<g id="proc~~dstoda~~CallsGraph_edge6" class="edge">
<title>proc~dstoda&#45;&gt;elco</title>
<path fill="none" stroke="#000000" d="M73.48,-125.96C93.45,-111.81 126.8,-88.16 149.8,-71.87"/>
<polygon fill="#000000" stroke="#000000" points="151.92,-74.65 158.05,-66.01 147.87,-68.94 151.92,-74.65"/>
</g>
<!-- tesco -->
<g id="proc~~dstoda~~CallsGraph_node8" class="node">
<title>tesco</title>
<polygon fill="#777777" stroke="#777777" points="203,-24 149,-24 149,0 203,0 203,-24"/>
<text text-anchor="middle" x="176" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">tesco</text>
</g>
<!-- proc~dstoda&#45;&gt;tesco -->
<g id="proc~~dstoda~~CallsGraph_edge7" class="edge">
<title>proc~dstoda&#45;&gt;tesco</title>
<path fill="none" stroke="#000000" d="M65.51,-125.92C80.98,-105.59 114.12,-63.72 147,-33 147.92,-32.14 148.88,-31.27 149.86,-30.42"/>
<polygon fill="#000000" stroke="#000000" points="152.09,-33.12 157.65,-24.1 147.68,-27.69 152.09,-33.12"/>
</g>
</g>
</svg>
</div>          <div>
            <a type="button" class="graph-help" data-bs-toggle="modal" href="#CallsGraph-help-text">Help</a>
          </div>
          <div class="modal fade" id="CallsGraph-help-text" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
<p>Nodes of different colours represent the following: </p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="641pt" height="28pt"
 viewBox="0.00 0.00 641.00 27.51" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.16 1.16) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28 741.5,-28 741.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="70,-24 0,-24 0,0 70,0 70,-24"/>
<text text-anchor="middle" x="35" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="146,-24 88,-24 88,0 146,0 146,-24"/>
<text text-anchor="middle" x="117" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node">
<title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="225.5,-24 164.5,-24 164.5,0 225.5,0 225.5,-24"/>
<text text-anchor="middle" x="195" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Type Bound Procedure -->
<g id="node4" class="node">
<title>Type Bound Procedure</title>
<polygon fill="#a7506f" stroke="#a7506f" points="374,-24 244,-24 244,0 374,0 374,-24"/>
<text text-anchor="middle" x="309" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Type Bound Procedure</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node5" class="node">
<title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="537.5,-24 392.5,-24 392.5,0 537.5,0 537.5,-24"/>
<text text-anchor="middle" x="465" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node6" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="614,-24 556,-24 556,0 614,0 614,-24"/>
<text text-anchor="middle" x="585" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node7" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="737.5,-24 632.5,-24 632.5,0 737.5,0 737.5,-24"/>
<text text-anchor="middle" x="685" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

<p>Solid arrows point from a procedure to one which it calls. Dashed 
arrows point from an interface to procedures which implement that interface.
This could include the module procedures in a generic interface or the
implementation in a submodule of an interface in a parent module.
</p>
 </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <br>


    <section>    
      <h2>Variables</h2>
      <table class="table table-striped varlist">
    <thead>
      <tr>
        <th scope="col">Type</th>
<th scope="col">Visibility</th>        <th scope="col">Attributes</th>
        <th scope="col"></th>
        <th scope="col">Name</th>
<th></th><th scope="col">Initial</th>        <th scope="col"></th>
    </thead>
    <tbody>
        <tr>
            <td>
              <span class="anchor" id="variable-alpha"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>alpha</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-dcon~3"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>dcon</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-ddn~3"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>ddn</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-del~3"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>del</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-delp~3"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>delp</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-dm1"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>dm1</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-dm2"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>dm2</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-dsm~3"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>dsm</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-dup~3"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>dup</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-exdn~3"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>exdn</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-exm1"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>exm1</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-exm2"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>exm2</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-exsm~3"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>exsm</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-exup~3"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>exup</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-i~43"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>i</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-i1~15"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>i1</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-iredo~3"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>iredo</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-iret~3"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>iret</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-j~24"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>j</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-jb~4"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>jb</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-lm1~2"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>lm1</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-lm1p1"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>lm1p1</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-lm2"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>lm2</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-lm2p1"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>lm2p1</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-m~6"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>m</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-ncf~3"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>ncf</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-newq~3"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>newq</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-nqm1~2"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>nqm1</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-nqm2"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>nqm2</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-pdh"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>pdh</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-pnorm"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>pnorm</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-r~11"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>r</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-rate"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>rate</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-rh~11"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>rh</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-rh1"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>rh1</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-rh1it"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>rh1it</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-rh2"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>rh2</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-rhdn~3"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>rhdn</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-rhsm~3"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>rhsm</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-rhup~3"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>rhup</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-rm"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>rm</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-sm1"></span>
              real(kind=dp),
            </td>
              <td>public,</td>
            <td>
parameter               
            </td>
            <td>::</td>
            <td><strong>sm1</strong>(12)</td>
<td> =</td>
                <td>[0.5D0, 0.575D0, 0.55D0, 0.45D0, 0.35D0, 0.25D0, 0.20D0, 0.15D0, 0.10D0, 0.075D0, 0.050D0, 0.025D0]</td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-told~3"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>told</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
    </tbody>
  </table>

    </section>
    <br>
    
    

    
    



    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl codehilite"><pre><span></span><span class="k">subroutine </span><span class="n">dstoda</span><span class="p">(</span><span class="n">Neq</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Yh</span><span class="p">,</span><span class="n">Nyh</span><span class="p">,</span><span class="n">Yh1</span><span class="p">,</span><span class="n">Ewt</span><span class="p">,</span><span class="n">Savf</span><span class="p">,</span><span class="n">Acor</span><span class="p">,</span><span class="n">Wm</span><span class="p">,</span><span class="n">Iwm</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">jac</span><span class="p">,</span><span class="n">pjac</span><span class="p">,</span><span class="n">slvs</span><span class="p">)</span>
<span class="c">!</span>
<span class="kt">integer</span><span class="w">                      </span><span class="kd">::</span><span class="w"> </span><span class="n">Neq</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">Y</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="kt">integer</span><span class="w">                      </span><span class="kd">::</span><span class="w"> </span><span class="n">Nyh</span>
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">Nyh</span><span class="p">,</span><span class="o">*</span><span class="p">)</span>
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">Yh1</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span><span class="w">                </span><span class="kd">::</span><span class="w"> </span><span class="n">Ewt</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">Savf</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">Acor</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span><span class="w">                </span><span class="kd">::</span><span class="w"> </span><span class="n">Wm</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="kt">integer</span><span class="w">                      </span><span class="kd">::</span><span class="w"> </span><span class="n">Iwm</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">external </span><span class="n">f</span>
<span class="k">external </span><span class="n">jac</span>
<span class="k">external </span><span class="n">pjac</span>
<span class="k">external </span><span class="n">slvs</span>

<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="n">dcon</span><span class="p">,</span><span class="w"> </span><span class="n">ddn</span><span class="p">,</span><span class="w"> </span><span class="n">del</span><span class="p">,</span><span class="w"> </span><span class="n">delp</span><span class="p">,</span><span class="w"> </span><span class="n">dm1</span><span class="p">,</span><span class="w"> </span><span class="n">dm2</span><span class="p">,</span><span class="w"> </span><span class="n">dsm</span><span class="p">,</span><span class="w"> </span><span class="n">dup</span><span class="p">,</span><span class="w"> </span><span class="n">exdn</span><span class="p">,</span><span class="w"> </span><span class="n">exm1</span><span class="p">,</span><span class="w"> </span><span class="n">exm2</span><span class="p">,</span><span class="w"> </span><span class="n">exsm</span><span class="p">,</span><span class="w"> </span><span class="n">exup</span><span class="p">,</span><span class="w"> </span><span class="n">pdh</span><span class="p">,</span><span class="w"> </span><span class="n">pnorm</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w">      </span><span class="p">&amp;</span>
<span class="w">              </span><span class="p">&amp;</span><span class="w"> </span><span class="n">rate</span><span class="p">,</span><span class="w"> </span><span class="n">rh</span><span class="p">,</span><span class="w"> </span><span class="n">rh1</span><span class="p">,</span><span class="w"> </span><span class="n">rh1it</span><span class="p">,</span><span class="w"> </span><span class="n">rh2</span><span class="p">,</span><span class="w"> </span><span class="n">rhdn</span><span class="p">,</span><span class="w"> </span><span class="n">rhsm</span><span class="p">,</span><span class="w"> </span><span class="n">rhup</span><span class="p">,</span><span class="w"> </span><span class="n">rm</span><span class="p">,</span><span class="w"> </span><span class="n">told</span>
<span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">i1</span><span class="p">,</span><span class="w"> </span><span class="n">iredo</span><span class="p">,</span><span class="w"> </span><span class="n">iret</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">lm1</span><span class="p">,</span><span class="w"> </span><span class="n">lm1p1</span><span class="p">,</span><span class="w"> </span><span class="n">lm2</span><span class="p">,</span><span class="w"> </span><span class="n">lm2p1</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">ncf</span><span class="p">,</span><span class="w"> </span><span class="n">newq</span><span class="p">,</span><span class="w"> </span><span class="n">nqm1</span><span class="p">,</span><span class="w"> </span><span class="n">nqm2</span>
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">sm1</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">=</span><span class="p">&amp;</span>
<span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="p">[</span><span class="mf">0.5D0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.575D0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.55D0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.45D0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.35D0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.25D0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.20D0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.15D0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.10D0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.075D0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.050D0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.025D0</span><span class="p">]</span>

<span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">told</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">tn</span>
<span class="n">ncf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">ierpj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">iersl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">jcur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">icf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">delp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">jstart</span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">400</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">jstart</span><span class="o">==-</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  The following block handles preliminaries needed when JSTART = -1.</span>
<span class="c">!  IPUP is set to MITER to force a matrix update.</span>
<span class="c">!  If an order increase is about to be considered (IALTH = 1),</span>
<span class="c">!  IALTH is reset to 2 to postpone consideration one more step.</span>
<span class="c">!  If the caller has changed METH, DCFODE is called to reset</span>
<span class="c">!  the coefficients of the method.</span>
<span class="c">!  If H is to be changed, YH must be rescaled.</span>
<span class="c">!  If H or METH is being changed, IALTH is reset to L = NQ + 1</span>
<span class="c">!  to prevent further changes in H for that many steps.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">lmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">maxord</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">meth</span><span class="o">==</span><span class="n">dlsa</span><span class="p">%</span><span class="n">mused</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">200</span>
<span class="w">   </span><span class="k">call </span><span class="n">dcfode</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">meth</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">elco</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">)</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="w">   </span><span class="n">iret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="k">else</span>
<span class="k">   if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">jstart</span><span class="o">==-</span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">200</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  On the first call, the order is set to 1, and other variables are</span>
<span class="c">!  initialized.  RMAX is the maximum ratio by which H can be increased</span>
<span class="c">!  in a single step.  It is initially 1.E4 to compensate for the small</span>
<span class="c">!  initial H, but then is normally equal to 10.  If a failure</span>
<span class="c">!  occurs (in corrector convergence or error test), RMAX is set at 2</span>
<span class="c">!  for the next increase.</span>
<span class="c">!  DCFODE is called to get the needed coefficients for both methods.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">lmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">maxord</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">rmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="mf">0.0D0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">el0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">crate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.7D0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">hold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">nslp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span>
<span class="w">   </span><span class="n">iret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="c">!  Initialize switching parameters.  METH = 1 is assumed initially. -----</span>
<span class="w">   </span><span class="n">dlsa</span><span class="p">%</span><span class="n">icount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span>
<span class="w">   </span><span class="n">dlsa</span><span class="p">%</span><span class="n">irflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="n">dlsa</span><span class="p">%</span><span class="n">pdest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="w">   </span><span class="n">dlsa</span><span class="p">%</span><span class="n">pdlast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="w">   </span><span class="n">dlsa</span><span class="p">%</span><span class="n">ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.0D0</span>
<span class="w">   </span><span class="k">call </span><span class="n">dcfode</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">elco</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">)</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span>
<span class="w">      </span><span class="n">dlsa</span><span class="p">%</span><span class="n">cm2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">elco</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">   call </span><span class="n">dcfode</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">elco</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">)</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span>
<span class="w">      </span><span class="n">dlsa</span><span class="p">%</span><span class="n">cm1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">elco</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">endif</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  The dls1%el vector and related constants are reset</span>
<span class="c">!  whenever the order NQ is changed, or at the start of the problem.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w"> </span><span class="mi">100</span><span class="w">  </span><span class="k">continue</span>
<span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">elco</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span>
<span class="k">enddo</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">nqnyh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="o">*</span><span class="n">Nyh</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">rc</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">el0</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">el0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">conit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5D0</span><span class="o">/</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
<span class="k">select case</span><span class="w"> </span><span class="p">(</span><span class="n">iret</span><span class="p">)</span>
<span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">   </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmin</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">))</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">300</span>
<span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">400</span>
<span class="k">case </span><span class="n">default</span>
<span class="k">endselect</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  If H is being changed, the H ratio RH is checked against</span>
<span class="c">!  RMAX, HMIN, and HMXI, and the YH array rescaled.  IALTH is set to</span>
<span class="c">!  L = NQ + 1 to prevent a change of H for that many steps, unless</span>
<span class="c">!  forced by a convergence or error test failure.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w"> </span><span class="mi">200</span><span class="w">  </span><span class="k">continue</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">==</span><span class="n">dls1</span><span class="p">%</span><span class="n">hold</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">400</span>
<span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">hold</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">hold</span>
<span class="n">iredo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="w"> </span><span class="mi">300</span><span class="w">  </span><span class="k">continue</span>
<span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">rmax</span><span class="p">)</span>
<span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rh</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="mf">1.0D0</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">)</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmxi</span><span class="o">*</span><span class="n">rh</span><span class="p">)</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  If METH = 1, also restrict the new step size by the stability region.</span>
<span class="c">!  If this reduces H, set IRFLAG to 1 so that if there are roundoff</span>
<span class="c">!  problems later, we can assume that is the cause of the trouble.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">meth</span><span class="o">/=</span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">dlsa</span><span class="p">%</span><span class="n">irflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="n">pdh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">)</span><span class="o">*</span><span class="n">dlsa</span><span class="p">%</span><span class="n">pdlast</span><span class="p">,</span><span class="mf">0.000001D0</span><span class="p">)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">rh</span><span class="o">*</span><span class="n">pdh</span><span class="o">*</span><span class="mf">1.00001D0</span><span class="o">&gt;=</span><span class="n">sm1</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sm1</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span><span class="o">/</span><span class="n">pdh</span>
<span class="w">      </span><span class="n">dlsa</span><span class="p">%</span><span class="n">irflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">endif</span>
<span class="k">endif</span>
<span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span>
<span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="w">   </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="o">*</span><span class="n">rh</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">      </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">r</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">enddo</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">*</span><span class="n">rh</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">rc</span><span class="o">*</span><span class="n">rh</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">iredo</span><span class="o">==</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">rmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="mf">0.0D0</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">1300</span>
<span class="k">endif</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  This section computes the predicted values by effectively</span>
<span class="c">!  multiplying the YH array by the Pascal triangle matrix.</span>
<span class="c">!  RC is the ratio of new to old values of the coefficient  H*EL(1).</span>
<span class="c">!  When RC differs from 1 by more than CCMAX, IPUP is set to MITER</span>
<span class="c">!  to force PJAC to be called, if a Jacobian is involved.</span>
<span class="c">!  In any case, PJAC is called at least every MSBP steps.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w"> </span><span class="mi">400</span><span class="w">  </span><span class="k">continue</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">rc</span><span class="o">-</span><span class="mf">1.0D0</span><span class="p">)</span><span class="o">&gt;</span><span class="n">dls1</span><span class="p">%</span><span class="n">ccmax</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nst</span><span class="o">&gt;=</span><span class="n">dls1</span><span class="p">%</span><span class="n">nslp</span><span class="o">+</span><span class="n">dls1</span><span class="p">%</span><span class="n">msbp</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">tn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">tn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span>
<span class="n">i1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nqnyh</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="k">do </span><span class="n">jb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span>
<span class="w">   </span><span class="n">i1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Nyh</span>
<span class="c">! DIR$ IVDEP</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nqnyh</span>
<span class="w">      </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">Nyh</span><span class="p">)</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">enddo</span>
<span class="n">pnorm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dmnorm</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span><span class="p">,</span><span class="n">Yh1</span><span class="p">,</span><span class="n">Ewt</span><span class="p">)</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  Up to MAXCOR corrector iterations are taken.  A convergence test is</span>
<span class="c">!  made on the RMS-norm of each correction, weighted by the error</span>
<span class="c">!  weight vector EWT.  The sum of the corrections is accumulated in the</span>
<span class="c">!  vector ACOR(i).  The YH array is not altered in the corrector loop.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w"> </span><span class="mi">500</span><span class="w">  </span><span class="k">continue</span>
<span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="n">del</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">   </span><span class="n">Y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="k">enddo</span>
<span class="k">call </span><span class="n">f</span><span class="p">(</span><span class="n">Neq</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">tn</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Savf</span><span class="p">)</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">nfe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nfe</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  If indicated, the matrix P = I - H*EL(1)*J is reevaluated and</span>
<span class="c">!  preprocessed before starting the corrector iteration.  IPUP is set</span>
<span class="c">!  to 0 as an indicator that this has been done.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">   </span><span class="k">call </span><span class="n">pjac</span><span class="p">(</span><span class="n">Neq</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Yh</span><span class="p">,</span><span class="n">Nyh</span><span class="p">,</span><span class="n">Ewt</span><span class="p">,</span><span class="n">Acor</span><span class="p">,</span><span class="n">Savf</span><span class="p">,</span><span class="n">Wm</span><span class="p">,</span><span class="n">Iwm</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">jac</span><span class="p">)</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">nslp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nst</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">crate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.7D0</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ierpj</span><span class="o">/=</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">800</span>
<span class="k">endif</span>
<span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">   </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="k">enddo</span>
<span class="k"> </span><span class="mi">600</span><span class="w">  </span><span class="k">continue</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span><span class="o">/=</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  In the case of the chord method, compute the corrector error,</span>
<span class="c">!  and solve the linear system with that as right-hand side and</span>
<span class="c">!  P as coefficient matrix.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">      </span><span class="n">Y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">*</span><span class="n">Savf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">   call </span><span class="n">slvs</span><span class="p">(</span><span class="n">Wm</span><span class="p">,</span><span class="n">Iwm</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Savf</span><span class="p">)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">iersl</span><span class="o">&lt;</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">800</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">iersl</span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">700</span>
<span class="w">   </span><span class="n">del</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dmnorm</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Ewt</span><span class="p">)</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">      </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">      </span><span class="n">Y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">else</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  In the case of functional iteration, update Y directly from</span>
<span class="c">!  the result of the last function evaluation.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">      </span><span class="n">Savf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">*</span><span class="n">Savf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="w">      </span><span class="n">Y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Savf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">   </span><span class="n">del</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dmnorm</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Ewt</span><span class="p">)</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">      </span><span class="n">Y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Savf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">      </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Savf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">endif</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  Test for convergence.  If M .gt. 0, an estimate of the convergence</span>
<span class="c">!  rate constant is stored in CRATE, and this is used in the test.</span>
<span class="c">!</span>
<span class="c">!  We first check for a change of iterates that is the size of</span>
<span class="c">!  roundoff error.  If this occurs, the iteration has converged, and a</span>
<span class="c">!  new rate estimate is not formed.</span>
<span class="c">!  In all other cases, force at least two iterations to estimate a</span>
<span class="c">!  local Lipschitz constant estimate for Adams methods.</span>
<span class="c">!  On convergence, form PDEST = local maximum Lipschitz constant</span>
<span class="c">!  estimate.  PDLAST is the most recent nonzero estimate.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">del</span><span class="o">&lt;=</span><span class="mi">10</span><span class="mf">0.0D0</span><span class="o">*</span><span class="n">pnorm</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">uround</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">900</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">m</span><span class="o">/=</span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">meth</span><span class="o">/=</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">m</span><span class="o">/=</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">102</span><span class="mf">4.0D0</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">del</span><span class="o">&lt;=</span><span class="mi">102</span><span class="mf">4.0D0</span><span class="o">*</span><span class="n">delp</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">del</span><span class="o">/</span><span class="n">delp</span>
<span class="w">      </span><span class="n">rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span><span class="n">rm</span><span class="p">)</span>
<span class="w">      </span><span class="n">dls1</span><span class="p">%</span><span class="n">crate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mf">0.2D0</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">crate</span><span class="p">,</span><span class="n">rm</span><span class="p">)</span>
<span class="w">   </span><span class="k">endif</span>
<span class="k">   </span><span class="n">dcon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">del</span><span class="o">*</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.0D0</span><span class="p">,</span><span class="mf">1.5D0</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">crate</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">conit</span><span class="p">)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dcon</span><span class="o">&lt;=</span><span class="mf">1.0D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">dlsa</span><span class="p">%</span><span class="n">pdest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">dlsa</span><span class="p">%</span><span class="n">pdest</span><span class="p">,</span><span class="n">rate</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dlsa</span><span class="p">%</span><span class="n">pdest</span><span class="o">/=</span><span class="mf">0.0D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">dlsa</span><span class="p">%</span><span class="n">pdlast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlsa</span><span class="p">%</span><span class="n">pdest</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="mi">900</span>
<span class="w">   </span><span class="k">endif</span>
<span class="k">endif</span>
<span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">m</span><span class="o">/=</span><span class="n">dls1</span><span class="p">%</span><span class="n">maxcor</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">m</span><span class="o">&lt;</span><span class="mi">2</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">del</span><span class="o">&lt;=</span><span class="mf">2.0D0</span><span class="o">*</span><span class="n">delp</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">delp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">del</span>
<span class="w">      </span><span class="k">call </span><span class="n">f</span><span class="p">(</span><span class="n">Neq</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">tn</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Savf</span><span class="p">)</span>
<span class="w">      </span><span class="n">dls1</span><span class="p">%</span><span class="n">nfe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nfe</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="mi">600</span>
<span class="w">   </span><span class="k">endif</span>
<span class="k">endif</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  The corrector iteration failed to converge.</span>
<span class="c">!  If MITER .ne. 0 and the Jacobian is out of date, PJAC is called for</span>
<span class="c">!  the next try.  Otherwise the YH array is retracted to its values</span>
<span class="c">!  before prediction, and H is reduced, if possible.  If H cannot be</span>
<span class="c">!  reduced or MXNCF failures have occurred, exit with KFLAG = -2.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w"> </span><span class="mi">700</span><span class="w">  </span><span class="k">continue</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span><span class="o">/=</span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">jcur</span><span class="o">/=</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">icf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">500</span>
<span class="k">endif</span>
<span class="k"> </span><span class="mi">800</span><span class="w">  </span><span class="k">continue</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">icf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="n">ncf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">rmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0D0</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">tn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">told</span>
<span class="n">i1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nqnyh</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="k">do </span><span class="n">jb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span>
<span class="w">   </span><span class="n">i1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Nyh</span>
<span class="c">! DIR$ IVDEP</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nqnyh</span>
<span class="w">      </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">Nyh</span><span class="p">)</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">enddo</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ierpj</span><span class="o">&lt;</span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">iersl</span><span class="o">&lt;</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">3</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">1400</span>
<span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmin</span><span class="o">*</span><span class="mf">1.00001D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">1400</span>
<span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ncf</span><span class="o">==</span><span class="n">dls1</span><span class="p">%</span><span class="n">mxncf</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">1400</span>
<span class="k">else</span>
<span class="k">   </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.25D0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span>
<span class="w">   </span><span class="n">iredo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmin</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">))</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">300</span>
<span class="k">endif</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  The corrector has converged.  JCUR is set to 0</span>
<span class="c">!  to signal that the Jacobian involved may need updating later.</span>
<span class="c">!  The local error test is made and control passes to statement 500</span>
<span class="c">!  if it fails.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w"> </span><span class="mi">900</span><span class="w">  </span><span class="k">continue</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">jcur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">m</span><span class="o">==</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">dsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">del</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">m</span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">dsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dmnorm</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span><span class="p">,</span><span class="n">Acor</span><span class="p">,</span><span class="n">Ewt</span><span class="p">)</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dsm</span><span class="o">&gt;</span><span class="mf">1.0D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  The error test failed.  KFLAG keeps track of multiple failures.</span>
<span class="c">!  Restore TN and the YH array to their previous values, and prepare</span>
<span class="c">!  to try the step again.  Compute the optimum step size for this or</span>
<span class="c">!  one lower order.  After 2 or more failures, H is forced to decrease</span>
<span class="c">!  by a factor of 0.2 or less.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">tn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">told</span>
<span class="w">   </span><span class="n">i1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nqnyh</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">do </span><span class="n">jb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span>
<span class="w">      </span><span class="n">i1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Nyh</span>
<span class="c">! DIR$ IVDEP</span>
<span class="w">      </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nqnyh</span>
<span class="w">         </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">Nyh</span><span class="p">)</span>
<span class="w">      </span><span class="k">enddo</span>
<span class="k">   enddo</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">rmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0D0</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmin</span><span class="o">*</span><span class="mf">1.00001D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  All returns are made through this section.  H is saved in HOLD</span>
<span class="c">!  to allow the caller to change H on the next step.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">      </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="mi">1400</span>
<span class="w">   </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="o">&lt;=-</span><span class="mi">3</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  Control reaches this section if 3 or more failures have occured.</span>
<span class="c">!  If 10 failures have occurred, exit with KFLAG = -1.</span>
<span class="c">!  It is assumed that the derivatives that have accumulated in the</span>
<span class="c">!  YH array have errors of the wrong order.  Hence the first</span>
<span class="c">!  derivative is recomputed, and the order is set to 1.  Then</span>
<span class="c">!  H is reduced by a factor of 10, and the step is retried,</span>
<span class="c">!  until it succeeds or H reaches HMIN.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="o">==-</span><span class="mi">10</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">         </span><span class="k">goto</span><span class="w"> </span><span class="mi">1400</span>
<span class="w">      </span><span class="k">else</span>
<span class="k">         </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1D0</span>
<span class="w">         </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmin</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">),</span><span class="n">rh</span><span class="p">)</span>
<span class="w">         </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">*</span><span class="n">rh</span>
<span class="w">         </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">            </span><span class="n">Y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="w">         </span><span class="k">enddo</span>
<span class="k">         call </span><span class="n">f</span><span class="p">(</span><span class="n">Neq</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">tn</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Savf</span><span class="p">)</span>
<span class="w">         </span><span class="n">dls1</span><span class="p">%</span><span class="n">nfe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nfe</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">            </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">*</span><span class="n">Savf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">         </span><span class="k">enddo</span>
<span class="k">         </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span>
<span class="w">         </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">400</span>
<span class="w">         </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">         </span><span class="n">iret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="w">         </span><span class="k">goto</span><span class="w"> </span><span class="mi">100</span>
<span class="w">      </span><span class="k">endif</span>
<span class="k">   else</span>
<span class="k">      </span><span class="n">iredo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">      </span><span class="n">rhup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="w">   </span><span class="k">endif</span>
<span class="k">else</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  After a successful step, update the YH array.</span>
<span class="c">!  Decrease ICOUNT by 1, and if it is -1, consider switching methods.</span>
<span class="c">!  If a method switch is made, reset various parameters,</span>
<span class="c">!  rescale the YH array, and exit.  If there is no switch,</span>
<span class="c">!  consider changing H if IALTH = 1.  Otherwise decrease IALTH by 1.</span>
<span class="c">!  If IALTH is then 1 and NQ .lt. MAXORD, then ACOR is saved for</span>
<span class="c">!  use in a possible order increase on the next step.</span>
<span class="c">!  If a change in H is considered, an increase or decrease in order</span>
<span class="c">!  by one is considered also.  A change in H is made only if it is by a</span>
<span class="c">!  factor of at least 1.1.  If not, IALTH is set to 3 to prevent</span>
<span class="c">!  testing for that many steps.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="n">iredo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">nst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nst</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">hu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">nqu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span>
<span class="w">   </span><span class="n">dlsa</span><span class="p">%</span><span class="n">mused</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">meth</span>
<span class="w">   </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="w">      </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">         </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">      </span><span class="k">enddo</span>
<span class="k">   enddo</span>
<span class="k">   </span><span class="n">dlsa</span><span class="p">%</span><span class="n">icount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlsa</span><span class="p">%</span><span class="n">icount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dlsa</span><span class="p">%</span><span class="n">icount</span><span class="o">&lt;</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">meth</span><span class="o">==</span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  We are currently using a BDF method.  Consider switching to Adams.</span>
<span class="c">!  Compute the step size we could have (ideally) used on this step,</span>
<span class="c">!  with the current (BDF) method, and also that for the Adams.</span>
<span class="c">!  If NQ .gt. MXORDN, we consider changing to order MXORDN on switching.</span>
<span class="c">!  Compare the two step sizes to decide whether to switch.</span>
<span class="c">!  The step size advantage must be at least 5/RATIO = 1 to switch.</span>
<span class="c">!  If the step size for Adams would be so small as to cause</span>
<span class="c">!  roundoff pollution, we stay with BDF.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">         </span><span class="n">exsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dlsa</span><span class="p">%</span><span class="n">mxordn</span><span class="o">&gt;=</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">dm1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dsm</span><span class="o">*</span><span class="p">(</span><span class="n">dlsa</span><span class="p">%</span><span class="n">cm2</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span><span class="o">/</span><span class="n">dlsa</span><span class="p">%</span><span class="n">cm1</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">))</span>
<span class="w">            </span><span class="n">rh1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.2D0</span><span class="o">*</span><span class="n">dm1</span><span class="o">**</span><span class="n">exsm</span><span class="o">+</span><span class="mf">0.0000012D0</span><span class="p">)</span>
<span class="w">            </span><span class="n">nqm1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span>
<span class="w">            </span><span class="n">exm1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exsm</span>
<span class="w">         </span><span class="k">else</span>
<span class="k">            </span><span class="n">nqm1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlsa</span><span class="p">%</span><span class="n">mxordn</span>
<span class="w">            </span><span class="n">lm1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlsa</span><span class="p">%</span><span class="n">mxordn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="n">exm1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="n">lm1</span>
<span class="w">            </span><span class="n">lm1p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lm1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="n">dm1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dmnorm</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span><span class="p">,</span><span class="n">Yh</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">lm1p1</span><span class="p">),</span><span class="n">Ewt</span><span class="p">)</span><span class="o">/</span><span class="n">dlsa</span><span class="p">%</span><span class="n">cm1</span><span class="p">(</span><span class="n">dlsa</span><span class="p">%</span><span class="n">mxordn</span><span class="p">)</span>
<span class="w">            </span><span class="n">rh1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.2D0</span><span class="o">*</span><span class="n">dm1</span><span class="o">**</span><span class="n">exm1</span><span class="o">+</span><span class="mf">0.0000012D0</span><span class="p">)</span>
<span class="w">         </span><span class="k">endif</span>
<span class="k">         </span><span class="n">rh1it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0D0</span><span class="o">*</span><span class="n">rh1</span>
<span class="w">         </span><span class="n">pdh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlsa</span><span class="p">%</span><span class="n">pdnorm</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">)</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">pdh</span><span class="o">*</span><span class="n">rh1</span><span class="o">&gt;</span><span class="mf">0.00001D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">rh1it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sm1</span><span class="p">(</span><span class="n">nqm1</span><span class="p">)</span><span class="o">/</span><span class="n">pdh</span>
<span class="w">         </span><span class="n">rh1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">rh1</span><span class="p">,</span><span class="n">rh1it</span><span class="p">)</span>
<span class="w">         </span><span class="n">rh2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.2D0</span><span class="o">*</span><span class="n">dsm</span><span class="o">**</span><span class="n">exsm</span><span class="o">+</span><span class="mf">0.0000012D0</span><span class="p">)</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">rh1</span><span class="o">*</span><span class="n">dlsa</span><span class="p">%</span><span class="n">ratio</span><span class="o">&gt;=</span><span class="mf">5.0D0</span><span class="o">*</span><span class="n">rh2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mf">0.001D0</span><span class="p">,</span><span class="n">rh1</span><span class="p">)</span>
<span class="w">            </span><span class="n">dm1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">alpha</span><span class="o">**</span><span class="n">exm1</span><span class="p">)</span><span class="o">*</span><span class="n">dm1</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dm1</span><span class="o">&gt;</span><span class="mi">100</span><span class="mf">0.0D0</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">uround</span><span class="o">*</span><span class="n">pnorm</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!  The switch test passed.  Reset relevant quantities for Adams. --------</span>
<span class="w">               </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rh1</span>
<span class="w">               </span><span class="n">dlsa</span><span class="p">%</span><span class="n">icount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span>
<span class="w">               </span><span class="n">dls1</span><span class="p">%</span><span class="n">meth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">               </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">               </span><span class="n">dlsa</span><span class="p">%</span><span class="n">pdlast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="w">               </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nqm1</span>
<span class="w">               </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">               </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmin</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">))</span>
<span class="w">               </span><span class="k">goto</span><span class="w"> </span><span class="mi">300</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">         endif</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  We are currently using an Adams method.  Consider switching to BDF.</span>
<span class="c">!  If the current order is greater than 5, assume the problem is</span>
<span class="c">!  not stiff, and skip this section.</span>
<span class="c">!  If the Lipschitz constant and error estimate are not polluted</span>
<span class="c">!  by roundoff, go to 470 and perform the usual test.</span>
<span class="c">!  Otherwise, switch to the BDF methods if the last step was</span>
<span class="c">!  restricted to insure stability (dlsa%irflag = 1), and stay with Adams</span>
<span class="c">!  method if not.  When switching to BDF with polluted error estimates,</span>
<span class="c">!  in the absence of other information, double the step size.</span>
<span class="c">!</span>
<span class="c">!  When the estimates are OK, we make the usual test by computing</span>
<span class="c">!  the step size we could have (ideally) used on this step,</span>
<span class="c">!  with the current (Adams) method, and also that for the BDF.</span>
<span class="c">!  If NQ .gt. MXORDS, we consider changing to order MXORDS on switching.</span>
<span class="c">!  Compare the two step sizes to decide whether to switch.</span>
<span class="c">!  The step size advantage must be at least RATIO = 5 to switch.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">      </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="o">&lt;=</span><span class="mi">5</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dsm</span><span class="o">&gt;</span><span class="mi">10</span><span class="mf">0.0D0</span><span class="o">*</span><span class="n">pnorm</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">uround</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">dlsa</span><span class="p">%</span><span class="n">pdest</span><span class="o">/=</span><span class="mf">0.0D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">exsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="w">            </span><span class="n">rh1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.2D0</span><span class="o">*</span><span class="n">dsm</span><span class="o">**</span><span class="n">exsm</span><span class="o">+</span><span class="mf">0.0000012D0</span><span class="p">)</span>
<span class="w">            </span><span class="n">rh1it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0D0</span><span class="o">*</span><span class="n">rh1</span>
<span class="w">            </span><span class="n">pdh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlsa</span><span class="p">%</span><span class="n">pdlast</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">pdh</span><span class="o">*</span><span class="n">rh1</span><span class="o">&gt;</span><span class="mf">0.00001D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">rh1it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sm1</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span><span class="o">/</span><span class="n">pdh</span>
<span class="w">            </span><span class="n">rh1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">rh1</span><span class="p">,</span><span class="n">rh1it</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="o">&lt;=</span><span class="n">dlsa</span><span class="p">%</span><span class="n">mxords</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">               </span><span class="n">dm2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dsm</span><span class="o">*</span><span class="p">(</span><span class="n">dlsa</span><span class="p">%</span><span class="n">cm1</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span><span class="o">/</span><span class="n">dlsa</span><span class="p">%</span><span class="n">cm2</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">))</span>
<span class="w">               </span><span class="n">rh2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.2D0</span><span class="o">*</span><span class="n">dm2</span><span class="o">**</span><span class="n">exsm</span><span class="o">+</span><span class="mf">0.0000012D0</span><span class="p">)</span>
<span class="w">               </span><span class="n">nqm2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span>
<span class="w">            </span><span class="k">else</span>
<span class="k">               </span><span class="n">nqm2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlsa</span><span class="p">%</span><span class="n">mxords</span>
<span class="w">               </span><span class="n">lm2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlsa</span><span class="p">%</span><span class="n">mxords</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">               </span><span class="n">exm2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="n">lm2</span>
<span class="w">               </span><span class="n">lm2p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lm2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">               </span><span class="n">dm2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dmnorm</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span><span class="p">,</span><span class="n">Yh</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">lm2p1</span><span class="p">),</span><span class="n">Ewt</span><span class="p">)</span><span class="o">/</span><span class="n">dlsa</span><span class="p">%</span><span class="n">cm2</span><span class="p">(</span><span class="n">dlsa</span><span class="p">%</span><span class="n">mxords</span><span class="p">)</span>
<span class="w">               </span><span class="n">rh2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.2D0</span><span class="o">*</span><span class="n">dm2</span><span class="o">**</span><span class="n">exm2</span><span class="o">+</span><span class="mf">0.0000012D0</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">rh2</span><span class="o">&lt;</span><span class="n">dlsa</span><span class="p">%</span><span class="n">ratio</span><span class="o">*</span><span class="n">rh1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">950</span>
<span class="w">         </span><span class="k">else</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dlsa</span><span class="p">%</span><span class="n">irflag</span><span class="o">==</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">950</span>
<span class="w">            </span><span class="n">rh2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0D0</span>
<span class="w">            </span><span class="n">nqm2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">,</span><span class="n">dlsa</span><span class="p">%</span><span class="n">mxords</span><span class="p">)</span>
<span class="w">         </span><span class="k">endif</span>
<span class="c">!  THE SWITCH TEST PASSED.  RESET RELEVANT QUANTITIES FOR BDF. ----------</span>
<span class="w">         </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rh2</span>
<span class="w">         </span><span class="n">dlsa</span><span class="p">%</span><span class="n">icount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span>
<span class="w">         </span><span class="n">dls1</span><span class="p">%</span><span class="n">meth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">         </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlsa</span><span class="p">%</span><span class="n">jtyp</span>
<span class="w">         </span><span class="n">dlsa</span><span class="p">%</span><span class="n">pdlast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="w">         </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nqm2</span>
<span class="w">         </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmin</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">))</span>
<span class="w">         </span><span class="k">goto</span><span class="w"> </span><span class="mi">300</span>
<span class="w">      </span><span class="k">endif</span>
<span class="k">   endif</span>
<span class="c">!</span>
<span class="c">!  No method switch is being made.  Do the usual step/order selection. --</span>
<span class="w"> </span><span class="mi">950</span><span class="w">  </span><span class="k">continue</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="o">==</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  Regardless of the success or failure of the step, factors</span>
<span class="c">!  RHDN, RHSM, and RHUP are computed, by which H could be multiplied</span>
<span class="c">!  at order NQ - 1, order NQ, or order NQ + 1, respectively.</span>
<span class="c">!  In the case of failure, RHUP = 0.0 to avoid an order increase.</span>
<span class="c">!  The largest of these is determined and the new order chosen</span>
<span class="c">!  accordingly.  If the order is to be increased, we compute one</span>
<span class="c">!  additional scaled derivative.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">      </span><span class="n">rhup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="o">/=</span><span class="n">dls1</span><span class="p">%</span><span class="n">lmax</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">            </span><span class="n">Savf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">lmax</span><span class="p">)</span>
<span class="w">         </span><span class="k">enddo</span>
<span class="k">         </span><span class="n">dup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dmnorm</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span><span class="p">,</span><span class="n">Savf</span><span class="p">,</span><span class="n">Ewt</span><span class="p">)</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span>
<span class="w">         </span><span class="n">exup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="w">         </span><span class="n">rhup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.4D0</span><span class="o">*</span><span class="n">dup</span><span class="o">**</span><span class="n">exup</span><span class="o">+</span><span class="mf">0.0000014D0</span><span class="p">)</span>
<span class="w">      </span><span class="k">endif</span>
<span class="k">   else</span>
<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="o">&lt;=</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="o">/=</span><span class="n">dls1</span><span class="p">%</span><span class="n">lmax</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">               </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">lmax</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">            </span><span class="k">enddo</span>
<span class="k">         endif</span>
<span class="k">      endif</span>
<span class="k">      goto</span><span class="w"> </span><span class="mi">1300</span>
<span class="w">   </span><span class="k">endif</span>
<span class="k">endif</span>
<span class="n">exsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="n">rhsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.2D0</span><span class="o">*</span><span class="n">dsm</span><span class="o">**</span><span class="n">exsm</span><span class="o">+</span><span class="mf">0.0000012D0</span><span class="p">)</span>
<span class="n">rhdn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="o">/=</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">ddn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dmnorm</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span><span class="p">,</span><span class="n">Yh</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="p">),</span><span class="n">Ewt</span><span class="p">)</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span>
<span class="w">   </span><span class="n">exdn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span>
<span class="w">   </span><span class="n">rhdn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.3D0</span><span class="o">*</span><span class="n">ddn</span><span class="o">**</span><span class="n">exdn</span><span class="o">+</span><span class="mf">0.0000013D0</span><span class="p">)</span>
<span class="k">endif</span>
<span class="c">!  If METH = 1, limit RH according to the stability region also. --------</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">meth</span><span class="o">/=</span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">pdh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">)</span><span class="o">*</span><span class="n">dlsa</span><span class="p">%</span><span class="n">pdlast</span><span class="p">,</span><span class="mf">0.000001D0</span><span class="p">)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="o">&lt;</span><span class="n">dls1</span><span class="p">%</span><span class="n">lmax</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">rhup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">rhup</span><span class="p">,</span><span class="n">sm1</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="p">)</span><span class="o">/</span><span class="n">pdh</span><span class="p">)</span>
<span class="w">   </span><span class="n">rhsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">rhsm</span><span class="p">,</span><span class="n">sm1</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span><span class="o">/</span><span class="n">pdh</span><span class="p">)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="o">&gt;</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">rhdn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">rhdn</span><span class="p">,</span><span class="n">sm1</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">pdh</span><span class="p">)</span>
<span class="w">   </span><span class="n">dlsa</span><span class="p">%</span><span class="n">pdest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="k">endif</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">rhsm</span><span class="o">&gt;=</span><span class="n">rhup</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">rhsm</span><span class="o">&gt;=</span><span class="n">rhdn</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">newq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span>
<span class="w">      </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rhsm</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">   </span><span class="k">endif</span>
<span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">rhup</span><span class="o">&gt;</span><span class="n">rhdn</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">newq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="w">   </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rhup</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">rh</span><span class="o">&lt;</span><span class="mf">1.1D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="mi">1300</span>
<span class="w">   </span><span class="k">else</span>
<span class="k">      </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="p">)</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="w">      </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">         </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">newq</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">r</span>
<span class="w">      </span><span class="k">enddo</span>
<span class="k">      goto</span><span class="w"> </span><span class="mi">1200</span>
<span class="w">   </span><span class="k">endif</span>
<span class="k">endif</span>
<span class="n">newq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rhdn</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="o">&lt;</span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">rh</span><span class="o">&gt;</span><span class="mf">1.0D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span>
<span class="c">!  If METH = 1 and H is restricted by stability, bypass 10 percent test.</span>
<span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="k">continue</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">meth</span><span class="o">/=</span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">rh</span><span class="o">*</span><span class="n">pdh</span><span class="o">*</span><span class="mf">1.00001D0</span><span class="o">&gt;=</span><span class="n">sm1</span><span class="p">(</span><span class="n">newq</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">1100</span>
<span class="k">endif</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="o">==</span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">rh</span><span class="o">&lt;</span><span class="mf">1.1D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">1300</span>
<span class="k">endif</span>
<span class="k"> </span><span class="mi">1100</span><span class="w"> </span><span class="k">continue</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="o">&lt;=-</span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="mf">0.2D0</span><span class="p">)</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  If there is a change of order, reset NQ, L, and the coefficients.</span>
<span class="c">!  In any case H is reset according to RH and the YH array is rescaled.</span>
<span class="c">!  Then exit from 690 if the step was OK, or redo the step otherwise.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">newq</span><span class="o">==</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmin</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">))</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">300</span>
<span class="k">endif</span>
<span class="k"> </span><span class="mi">1200</span><span class="w"> </span><span class="k">continue</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newq</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="n">iret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="k">goto</span><span class="w"> </span><span class="mi">100</span>
<span class="w"> </span><span class="mi">1300</span><span class="w"> </span><span class="k">continue</span>
<span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">nqu</span><span class="p">)</span>
<span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">   </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">r</span>
<span class="k">enddo</span>
<span class="k"> </span><span class="mi">1400</span><span class="w"> </span><span class="k">continue</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">hold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">jstart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="k">end subroutine </span><span class="n">dstoda</span>
</pre></div>

    </section>
    <br>
    
    </div>
  </div>

      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row justify-content-between">
          <div class="col"><p>odepack was developed by Alan C. Hindmarsh as modified by John S. Urban, Jacob Williams<br>&copy; 2024 
</p>
          </div>
          <div class="col">
            <p class="text-end">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
 on 2024-03-30 00:11              </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>    

    <!-- MathJax JavaScript
             ================================================== -->
             <!-- Placed at the end of the document so the pages load faster -->
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
          TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
          jax: ['input/TeX','input/MathML','output/HTML-CSS'],
          extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
          });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

          <script src="../tipuesearch/tipuesearch_content.js"></script>
          <script src="../tipuesearch/tipuesearch_set.js"></script>
          <script src="../tipuesearch/tipuesearch.js"></script>

  </body>
</html>