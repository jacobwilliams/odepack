<!-- -*- mode: jinja2 -*- -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="ODEPACK - A Systematized Collection of ODE Solvers">
    <meta name="author" content="Alan C. Hindmarsh as modified by John S. Urban, Jacob Williams" >
    <link rel="icon" href="../favicon.png">

    <title>dstodpk &ndash; odepack</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
      <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
      <link href="../css/user.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>
  </head>

  <body>

    <!-- Fixed navbar -->
    <div class="container-fluid mb-sm-4 mb-xl-2">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
          <a class="navbar-brand" href="../index.html">odepack </a>
          <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar"
                  aria-expanded="false" aria-controls="navbar" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon">
          </button>

          <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav">
                  <li class="nav-item">
                    <a class="nav-link" href="../lists/files.html">Source Files</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/modules.html">Modules</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/procedures.html">Procedures</a>
                </li>
            </ul>
              <div class="d-flex align-items-end flex-grow-1">
                <form action="../search.html" role="search" class="ms-auto">
                  <input type="text" class="form-control" aria-label="Search" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
                </form>
              </div>
          </div><!--/.nav-collapse -->
        </div>
      </nav>
    </div>

    <div class="container">
  <div class="row">
    <h1>dstodpk
      <small>Subroutine</small>
      
    </h1>
      <div class="container p-2 mb-4 bg-light border rounded-3">
    <div class="row align-items-center justify-content-between" id="info-bar">
      <div class="col">
        <ul class="list-inline" style="margin-bottom:0px;display:inline">

            <li class="list-inline-item" id="statements"><i class="fa fa-list-ol"></i>
              <a data-bs-toggle="tooltip"
                 data-bs-placement="bottom" data-html="true"
                 title=" 1.6% of total for procedures.">365 statements</a>
            </li>

            <li class="list-inline-item" id="source-file">
              <i class="fa fa-code"></i>
              <a href="../src/dstodpk.inc"> Source File</a>
            </li>
        </ul>
      </div>
      <div class="col">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb justify-content-end mb-0">
                <li class="breadcrumb-item"><a href='../sourcefile/dstodpk.inc.html'>dstodpk.inc</a></li>
            <li class="breadcrumb-item active" aria-current="page">dstodpk</li>
          </ol>
        </nav>
      </div>
    </div>
  </div>
  <script>
    $(function () {
    $('[data-bs-toggle="tooltip"]').tooltip()
    })
  </script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
      <div id="sidebar">
      <h3>Contents</h3>
  
      <div class="card mb-4">
      <a data-bs-toggle="collapse" href="#vars-0"
         aria-expanded="false" aria-controls="vars-0">
         <h4 class="card-header bg-primary text-white">Variables</h4>
      </a>
      <div id="vars-0" class="collapse">
        <div class="list-group list-group-flush">
            <a class="list-group-item" href="../proc/dstodpk.html#variable-dcon~4">dcon</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-ddn~4">ddn</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-del~4">del</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-delp~4">delp</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-dsm~4">dsm</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-dup~4">dup</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-exdn~4">exdn</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-exsm~4">exsm</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-exup~4">exup</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-i~33">i</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-i1~10">i1</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-iredo~4">iredo</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-iret~4">iret</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-j~14">j</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-jb~4">jb</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-m~8">m</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-ncf~4">ncf</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-newq~4">newq</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-r~5">r</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-rh~8">rh</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-rhdn~4">rhdn</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-rhsm~4">rhsm</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-rhup~4">rhup</a>
            <a class="list-group-item" href="../proc/dstodpk.html#variable-told~4">told</a>
        </div>
      </div>
    </div>

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    <div class="card card-primary">
      <div class="card-header text-left"><h3 class="card-title">Source Code</h3></div>
      <div class="list-group">
        <a class="list-group-item" href="../proc/dstodpk.html#src">dstodpk</a>
      </div>
    </div>


  </div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2> subroutine dstodpk(Neq, Y, Yh, Nyh, Yh1, Ewt, Savf, Savx, Acor, Wm, Iwm, f, jac, psol)  
</h2>
    

    <p>DSTODPK performs one step of the integration of an initial value
problem for a system of Ordinary Differential Equations.</p>
<p>The following changes were made to generate Subroutine DSTODPK
from Subroutine DSTODE:</p>
<ol>
<li>The array SAVX was added to the call sequence.</li>
<li>PJAC and SLVS were replaced by PSOL in the call sequence.</li>
<li>The Common block /DLPK01/ was added for communication.</li>
<li>The test constant EPCON is loaded into Common below statement
   numbers 125 and 155, and used below statement 400.</li>
<li>The Newton iteration counter MNEWT is set below 220 and 400.</li>
<li>The call to PJAC was replaced with a call to DPKSET (fixed name),
   with a longer call sequence, called depending on JACFLG.</li>
<li>The corrector residual is stored in SAVX (not Y) at 360,
   and the solution vector is in SAVX in the 380 loop.</li>
<li>SLVS was renamed DSOLPK and includes NEQ, SAVX, EWT, F, and JAC.
   SAVX was added because DSOLPK now needs Y and SAVF undisturbed.</li>
<li>The nonlinear convergence failure count NCFN is set at 430.</li>
</ol>
<p>Note: DSTODPK is independent of the value of the iteration method
indicator MITER, when this is .ne. 0, and hence is independent
of the type of chord method used, or the Jacobian structure.</p>
<p>Communication with DSTODPK is done with the following variables:</p>
<dl>
<dt>NEQ</dt>
<dd>
<p>integer array containing problem size in NEQ(1), and
passed as the NEQ argument in all calls to F and JAC.</p>
</dd>
<dt>Y</dt>
<dd>
<p>an array of length .ge. N used as the Y argument in
all calls to F and JAC.</p>
</dd>
<dt>YH</dt>
<dd>
<p>an NYH by LMAX array containing the dependent variables
and their approximate scaled derivatives, where
LMAX = MAXORD + 1.  YH(i,j+1) contains the approximate
j-th derivative of y(i), scaled by H**j/factorial(j)
(j = 0,1,&hellip;,NQ).  On entry for the first step, the first
two columns of YH must be set from the initial values.</p>
</dd>
<dt>NYH</dt>
<dd>
<p>a constant integer .ge. N, the first dimension of YH.</p>
</dd>
<dt>YH1</dt>
<dd>
<p>a one-dimensional array occupying the same space as YH.</p>
</dd>
<dt>EWT</dt>
<dd>
<p>an array of length N containing multiplicative weights
for local error measurements.  Local errors in y(i) are
compared to 1.0/EWT(i) in various error tests.</p>
</dd>
<dt>SAVF</dt>
<dd>
<p>an array of working storage, of length N.
Also used for input of YH(*,MAXORD+2) when JSTART = -1
and MAXORD .lt. the current order NQ.</p>
</dd>
<dt>SAVX</dt>
<dd>
<p>an array of working storage, of length N.</p>
</dd>
<dt>ACOR</dt>
<dd>
<p>a work array of length N, used for the accumulated
corrections.  On a successful return, ACOR(i) contains
the estimated one-step local error in y(i).</p>
</dd>
<dt>WM,IWM</dt>
<dd>
<p>real and integer work arrays associated with matrix
operations in chord iteration (MITER .ne. 0).</p>
</dd>
<dt>CCMAX</dt>
<dd>
<p>maximum relative change in H*EL0 before DPKSET is called.</p>
</dd>
<dt>H</dt>
<dd>
<p>the step size to be attempted on the next step.
H is altered by the error control algorithm during the
problem.  H can be either positive or negative, but its
sign must remain constant throughout the problem.</p>
</dd>
<dt>HMIN</dt>
<dd>
<p>the minimum absolute value of the step size H to be used.</p>
</dd>
<dt>HMXI</dt>
<dd>
<p>inverse of the maximum absolute value of H to be used.
HMXI = 0.0 is allowed and corresponds to an infinite HMAX.
HMIN and HMXI may be changed at any time, but will not
take effect until the next change of H is considered.</p>
</dd>
<dt>TN</dt>
<dd>
<p>the independent variable. TN is updated on each step taken.</p>
</dd>
<dt>JSTART</dt>
<dd>
<p>an integer used for input only, with the following
values and meanings:</p>
<div class="codehilite"><pre><span></span><code><span class="w">     </span><span class="mi">0</span><span class="w">  </span><span class="nv">perform</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">first</span><span class="w"> </span><span class="nv">step</span>.
<span class="w"> </span>.<span class="nv">gt</span>.<span class="mi">0</span><span class="w">  </span><span class="nv">take</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">step</span><span class="w"> </span><span class="nv">continuing</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">last</span>.
<span class="w">    </span><span class="o">-</span><span class="mi">1</span><span class="w">  </span><span class="nv">take</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="k">next</span><span class="w"> </span><span class="nv">step</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">H</span>,<span class="w"> </span><span class="nv">MAXORD</span>,
<span class="w">        </span><span class="nv">N</span>,<span class="w"> </span><span class="nv">METH</span>,<span class="w"> </span><span class="nv">MITER</span>,<span class="w"> </span><span class="nv">and</span><span class="o">/</span><span class="nv">or</span><span class="w"> </span><span class="nv">matrix</span><span class="w"> </span><span class="nv">parameters</span>.
<span class="w">    </span><span class="o">-</span><span class="mi">2</span><span class="w">  </span><span class="nv">take</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="k">next</span><span class="w"> </span><span class="nv">step</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">H</span>,
<span class="w">        </span><span class="nv">but</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">other</span><span class="w"> </span><span class="nv">inputs</span><span class="w"> </span><span class="nv">unchanged</span>.
</code></pre></div>

</dd>
</dl>
<p>On return, JSTART is set to 1 to facilitate continuation.</p>
<dl>
<dt>KFLAG</dt>
<dd>
<p>a completion code with the following meanings:</p>
<div class="codehilite"><pre><span></span><code>     0  the step was succesful.
    -1  the requested error could not be achieved.
    -2  corrector convergence could not be achieved.
    -3  fatal error in DPKSET or DSOLPK.
</code></pre></div>

</dd>
</dl>
<p>A return with KFLAG = -1 or -2 means either
ABS(H) = HMIN or 10 consecutive failures occurred.
On a return with KFLAG negative, the values of TN and
the YH array are as of the beginning of the last
step, and H is the last step size attempted.</p>
<dl>
<dt>MAXORD</dt>
<dd>
<p>the maximum order of integration method to be allowed.</p>
</dd>
<dt>MAXCOR</dt>
<dd>
<p>the maximum number of corrector iterations allowed.</p>
</dd>
<dt>MSBP</dt>
<dd>
<p>maximum number of steps between DPKSET calls (MITER .gt. 0).</p>
</dd>
<dt>MXNCF</dt>
<dd>
<p>maximum number of convergence failures allowed.</p>
</dd>
<dt>METH/MITER</dt>
<dd>
<p>the method flags.  See description in driver.</p>
</dd>
<dt>N</dt>
<dd>
<p>the number of first-order differential equations.</p>
</dd>
</dl>


    <h3>Arguments</h3>
        <table class="table table-striped varlist">
    <thead>
      <tr>
        <th scope="col">Type</th>
<th scope="col">Intent</th><th scope="col">Optional</th>        <th scope="col">Attributes</th>
        <th scope="col"></th>
        <th scope="col">Name</th>
        <th scope="col"></th>
    </thead>
    <tbody>
        <tr>
            <td>
              <span class="anchor" id="variable-neq~19"></span>
              integer,
            </td>
<td></td>
              <td></td>            <td>
              dimension(*)
            </td>
            <td>::</td>
            <td><strong>Neq</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-y~19"></span>
              real(kind=dp),
            </td>
<td></td>
              <td></td>            <td>
              dimension(*)
            </td>
            <td>::</td>
            <td><strong>Y</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-yh~5"></span>
              real(kind=dp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(Nyh,*)
            </td>
            <td>::</td>
            <td><strong>Yh</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-nyh~5"></span>
              integer,
            </td>
<td>intent(in)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>Nyh</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-yh1~4"></span>
              real(kind=dp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(*)
            </td>
            <td>::</td>
            <td><strong>Yh1</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-ewt~6"></span>
              real(kind=dp),
            </td>
<td></td>
              <td></td>            <td>
              dimension(*)
            </td>
            <td>::</td>
            <td><strong>Ewt</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-savf~10"></span>
              real(kind=dp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(*)
            </td>
            <td>::</td>
            <td><strong>Savf</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-savx~2"></span>
              real(kind=dp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(*)
            </td>
            <td>::</td>
            <td><strong>Savx</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-acor~4"></span>
              real(kind=dp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(*)
            </td>
            <td>::</td>
            <td><strong>Acor</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-wm~7"></span>
              real(kind=dp),
            </td>
<td></td>
              <td></td>            <td>
              dimension(*)
            </td>
            <td>::</td>
            <td><strong>Wm</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-iwm~7"></span>
              integer,
            </td>
<td></td>
              <td></td>            <td>
              dimension(*)
            </td>
            <td>::</td>
            <td><strong>Iwm</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-f~13"></span>
              real
            </td>
<td></td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>f</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-jac~10"></span>
              integer
            </td>
<td></td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>jac</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-psol~7"></span>
              real
            </td>
<td></td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>psol</strong></td>
            <td>
                
            </td>
        </tr>
    </tbody>
  </table>

    <br>
    <div class="card">
      <div class="card-header">
  <h3 class="card-title">Calls</h3>
      </div>
      <div class="card-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: proc~~dstodpk~~CallsGraph Pages: 1 -->
<svg id="procdstodpkCallsGraph" width="221pt" height="284pt"
 viewBox="0.00 0.00 221.00 284.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~dstodpk~~CallsGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 280)">
<title>proc~~dstodpk~~CallsGraph</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-280 217,-280 217,4 -4,4"/>
<!-- proc~dstodpk -->
<g id="proc~~dstodpk~~CallsGraph_node1" class="node">
<title>proc~dstodpk</title>
<polygon fill="none" stroke="black" points="123,-150 0,-150 0,-126 123,-126 123,-150"/>
<text text-anchor="middle" x="61.5" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50">dstodpk.inc::dstodpk</text>
</g>
<!-- dcfode -->
<g id="proc~~dstodpk~~CallsGraph_node2" class="node">
<title>dcfode</title>
<polygon fill="#777777" stroke="#777777" points="213,-276 159,-276 159,-252 213,-252 213,-276"/>
<text text-anchor="middle" x="186" y="-261.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dcfode</text>
</g>
<!-- proc~dstodpk&#45;&gt;dcfode -->
<g id="proc~~dstodpk~~CallsGraph_edge1" class="edge">
<title>proc~dstodpk&#45;&gt;dcfode</title>
<path fill="none" stroke="#000000" d="M72.67,-150.19C89.69,-170.34 125.41,-211.49 159,-243 159.8,-243.75 160.63,-244.51 161.48,-245.27"/>
<polygon fill="#000000" stroke="#000000" points="159.4,-248.1 169.28,-251.93 163.95,-242.78 159.4,-248.1"/>
</g>
<!-- dpkset -->
<g id="proc~~dstodpk~~CallsGraph_node3" class="node">
<title>dpkset</title>
<polygon fill="#777777" stroke="#777777" points="213,-234 159,-234 159,-210 213,-210 213,-234"/>
<text text-anchor="middle" x="186" y="-219.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dpkset</text>
</g>
<!-- proc~dstodpk&#45;&gt;dpkset -->
<g id="proc~~dstodpk~~CallsGraph_edge2" class="edge">
<title>proc~dstodpk&#45;&gt;dpkset</title>
<path fill="none" stroke="#000000" d="M80.05,-150.04C100.7,-164.19 135.18,-187.84 158.95,-204.13"/>
<polygon fill="#000000" stroke="#000000" points="157.25,-207.22 167.48,-209.99 161.21,-201.45 157.25,-207.22"/>
</g>
<!-- dsolpk -->
<g id="proc~~dstodpk~~CallsGraph_node4" class="node">
<title>dsolpk</title>
<polygon fill="#777777" stroke="#777777" points="213,-192 159,-192 159,-168 213,-168 213,-192"/>
<text text-anchor="middle" x="186" y="-177.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dsolpk</text>
</g>
<!-- proc~dstodpk&#45;&gt;dsolpk -->
<g id="proc~~dstodpk~~CallsGraph_edge3" class="edge">
<title>proc~dstodpk&#45;&gt;dsolpk</title>
<path fill="none" stroke="#000000" d="M97.6,-150.04C113.76,-155.58 132.91,-162.14 149.16,-167.71"/>
<polygon fill="#000000" stroke="#000000" points="148.26,-171.1 158.85,-171.03 150.53,-164.48 148.26,-171.1"/>
</g>
<!-- dvnorm -->
<g id="proc~~dstodpk~~CallsGraph_node5" class="node">
<title>dvnorm</title>
<polygon fill="#777777" stroke="#777777" points="213,-150 159,-150 159,-126 213,-126 213,-150"/>
<text text-anchor="middle" x="186" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dvnorm</text>
</g>
<!-- proc~dstodpk&#45;&gt;dvnorm -->
<g id="proc~~dstodpk~~CallsGraph_edge4" class="edge">
<title>proc~dstodpk&#45;&gt;dvnorm</title>
<path fill="none" stroke="#000000" d="M123.03,-138C131.83,-138 140.66,-138 148.77,-138"/>
<polygon fill="#000000" stroke="#000000" points="148.97,-141.5 158.97,-138 148.97,-134.5 148.97,-141.5"/>
</g>
<!-- el -->
<g id="proc~~dstodpk~~CallsGraph_node6" class="node">
<title>el</title>
<polygon fill="#777777" stroke="#777777" points="213,-108 159,-108 159,-84 213,-84 213,-108"/>
<text text-anchor="middle" x="186" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">el</text>
</g>
<!-- proc~dstodpk&#45;&gt;el -->
<g id="proc~~dstodpk~~CallsGraph_edge5" class="edge">
<title>proc~dstodpk&#45;&gt;el</title>
<path fill="none" stroke="#000000" d="M97.6,-125.96C113.76,-120.42 132.91,-113.86 149.16,-108.29"/>
<polygon fill="#000000" stroke="#000000" points="150.53,-111.52 158.85,-104.97 148.26,-104.9 150.53,-111.52"/>
</g>
<!-- elco -->
<g id="proc~~dstodpk~~CallsGraph_node7" class="node">
<title>elco</title>
<polygon fill="#777777" stroke="#777777" points="213,-66 159,-66 159,-42 213,-42 213,-66"/>
<text text-anchor="middle" x="186" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">elco</text>
</g>
<!-- proc~dstodpk&#45;&gt;elco -->
<g id="proc~~dstodpk~~CallsGraph_edge6" class="edge">
<title>proc~dstodpk&#45;&gt;elco</title>
<path fill="none" stroke="#000000" d="M80.05,-125.96C100.7,-111.81 135.18,-88.16 158.95,-71.87"/>
<polygon fill="#000000" stroke="#000000" points="161.21,-74.55 167.48,-66.01 157.25,-68.78 161.21,-74.55"/>
</g>
<!-- tesco -->
<g id="proc~~dstodpk~~CallsGraph_node8" class="node">
<title>tesco</title>
<polygon fill="#777777" stroke="#777777" points="213,-24 159,-24 159,0 213,0 213,-24"/>
<text text-anchor="middle" x="186" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">tesco</text>
</g>
<!-- proc~dstodpk&#45;&gt;tesco -->
<g id="proc~~dstodpk~~CallsGraph_edge7" class="edge">
<title>proc~dstodpk&#45;&gt;tesco</title>
<path fill="none" stroke="#000000" d="M72.67,-125.81C89.69,-105.66 125.41,-64.51 159,-33 159.8,-32.25 160.63,-31.49 161.48,-30.73"/>
<polygon fill="#000000" stroke="#000000" points="163.95,-33.22 169.28,-24.07 159.4,-27.9 163.95,-33.22"/>
</g>
</g>
</svg>
</div>          <div>
            <a type="button" class="graph-help" data-bs-toggle="modal" href="#CallsGraph-help-text">Help</a>
          </div>
          <div class="modal fade" id="CallsGraph-help-text" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
<p>Nodes of different colours represent the following: </p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="641pt" height="28pt"
 viewBox="0.00 0.00 641.00 27.51" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.16 1.16) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28 741.5,-28 741.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="70,-24 0,-24 0,0 70,0 70,-24"/>
<text text-anchor="middle" x="35" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="146,-24 88,-24 88,0 146,0 146,-24"/>
<text text-anchor="middle" x="117" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node">
<title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="225.5,-24 164.5,-24 164.5,0 225.5,0 225.5,-24"/>
<text text-anchor="middle" x="195" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Type Bound Procedure -->
<g id="node4" class="node">
<title>Type Bound Procedure</title>
<polygon fill="#a7506f" stroke="#a7506f" points="374,-24 244,-24 244,0 374,0 374,-24"/>
<text text-anchor="middle" x="309" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Type Bound Procedure</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node5" class="node">
<title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="537.5,-24 392.5,-24 392.5,0 537.5,0 537.5,-24"/>
<text text-anchor="middle" x="465" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node6" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="614,-24 556,-24 556,0 614,0 614,-24"/>
<text text-anchor="middle" x="585" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node7" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="737.5,-24 632.5,-24 632.5,0 737.5,0 737.5,-24"/>
<text text-anchor="middle" x="685" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

<p>Solid arrows point from a procedure to one which it calls. Dashed 
arrows point from an interface to procedures which implement that interface.
This could include the module procedures in a generic interface or the
implementation in a submodule of an interface in a parent module.
</p>
 </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <br>


    <section>    
      <h2>Variables</h2>
      <table class="table table-striped varlist">
    <thead>
      <tr>
        <th scope="col">Type</th>
<th scope="col">Visibility</th>        <th scope="col">Attributes</th>
        <th scope="col"></th>
        <th scope="col">Name</th>
<th></th><th scope="col">Initial</th>        <th scope="col"></th>
    </thead>
    <tbody>
        <tr>
            <td>
              <span class="anchor" id="variable-dcon~4"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>dcon</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-ddn~4"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>ddn</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-del~4"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>del</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-delp~4"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>delp</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-dsm~4"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>dsm</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-dup~4"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>dup</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-exdn~4"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>exdn</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-exsm~4"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>exsm</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-exup~4"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>exup</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-i~33"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>i</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-i1~10"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>i1</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-iredo~4"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>iredo</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-iret~4"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>iret</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-j~14"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>j</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-jb~4"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>jb</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-m~8"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>m</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-ncf~4"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>ncf</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-newq~4"></span>
              integer,
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>newq</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-r~5"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>r</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-rh~8"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>rh</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-rhdn~4"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>rhdn</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-rhsm~4"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>rhsm</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-rhup~4"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>rhup</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-told~4"></span>
              real(kind=dp),
            </td>
              <td>public</td>
            <td>
              
            </td>
            <td>::</td>
            <td><strong>told</strong></td>
                <td></td>
                <td></td>
            <td>
                
            </td>
        </tr>
    </tbody>
  </table>

    </section>
    <br>
    
    

    
    



    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl codehilite"><pre><span></span><span class="k">subroutine </span><span class="n">dstodpk</span><span class="p">(</span><span class="n">Neq</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Yh</span><span class="p">,</span><span class="n">Nyh</span><span class="p">,</span><span class="n">Yh1</span><span class="p">,</span><span class="n">Ewt</span><span class="p">,</span><span class="n">Savf</span><span class="p">,</span><span class="n">Savx</span><span class="p">,</span><span class="n">Acor</span><span class="p">,</span><span class="n">Wm</span><span class="p">,</span><span class="n">Iwm</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">jac</span><span class="p">,</span><span class="n">psol</span><span class="p">)</span>

<span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">Neq</span>
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">Y</span>
<span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">Nyh</span>
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">Nyh</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">Yh</span>
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">Yh1</span>
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">Ewt</span>
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">Savf</span>
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">Savx</span>
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">Acor</span>
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">Wm</span>
<span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">Iwm</span>
<span class="k">external </span><span class="n">f</span>
<span class="k">external </span><span class="n">jac</span>
<span class="k">external </span><span class="n">psol</span>

<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dcon</span><span class="p">,</span><span class="w"> </span><span class="n">ddn</span><span class="p">,</span><span class="w"> </span><span class="n">del</span><span class="p">,</span><span class="w"> </span><span class="n">delp</span><span class="p">,</span><span class="w"> </span><span class="n">dsm</span><span class="p">,</span><span class="w"> </span><span class="n">dup</span><span class="p">,</span><span class="w"> </span><span class="n">exdn</span><span class="p">,</span><span class="w"> </span><span class="n">exsm</span><span class="p">,</span><span class="w"> </span><span class="n">exup</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">rh</span><span class="p">,</span><span class="w"> </span><span class="n">rhdn</span><span class="p">,</span><span class="w"> </span><span class="n">rhsm</span><span class="p">,</span><span class="w"> </span><span class="n">rhup</span><span class="p">,</span><span class="w"> </span><span class="n">told</span>
<span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">i1</span><span class="p">,</span><span class="w"> </span><span class="n">iredo</span><span class="p">,</span><span class="w"> </span><span class="n">iret</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">ncf</span><span class="p">,</span><span class="w"> </span><span class="n">newq</span>

<span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">told</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">tn</span>
<span class="n">ncf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">ierpj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">iersl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">jcur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">icf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">delp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">jstart</span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">400</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">jstart</span><span class="o">==-</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  The following block handles preliminaries needed when JSTART = -1.</span>
<span class="c">!  IPUP is set to MITER to force a matrix update.</span>
<span class="c">!  If an order increase is about to be considered (IALTH = 1),</span>
<span class="c">!  IALTH is reset to 2 to postpone consideration one more step.</span>
<span class="c">!  If the caller has changed METH, DCFODE is called to reset</span>
<span class="c">!  the coefficients of the method.</span>
<span class="c">!  If the caller has changed MAXORD to a value less than the current</span>
<span class="c">!  order NQ, NQ is reduced to MAXORD, and a new H chosen accordingly.</span>
<span class="c">!  If H is to be changed, YH must be rescaled.</span>
<span class="c">!  If H or METH is being changed, IALTH is reset to L = NQ + 1</span>
<span class="c">!  to prevent further changes in H for that many steps.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">lmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">maxord</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">meth</span><span class="o">/=</span><span class="n">dls1</span><span class="p">%</span><span class="n">meo</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="n">dcfode</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">meth</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">elco</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">)</span>
<span class="w">      </span><span class="n">dls1</span><span class="p">%</span><span class="n">meo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">meth</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="o">&lt;=</span><span class="n">dls1</span><span class="p">%</span><span class="n">maxord</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="w">         </span><span class="n">iret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="k">goto</span><span class="w"> </span><span class="mi">100</span>
<span class="w">      </span><span class="k">endif</span>
<span class="k">   elseif</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="o">&lt;=</span><span class="n">dls1</span><span class="p">%</span><span class="n">maxord</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      goto</span><span class="w"> </span><span class="mi">200</span>
<span class="w">   </span><span class="k">endif</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">maxord</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">lmax</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="w">      </span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">elco</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">nqnyh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="o">*</span><span class="n">Nyh</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">rc</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">el0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">el0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">conit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5D0</span><span class="o">/</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
<span class="w">   </span><span class="n">dlpk</span><span class="p">%</span><span class="n">epcon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">conit</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span>
<span class="w">   </span><span class="n">ddn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dvnorm</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span><span class="p">,</span><span class="n">Savf</span><span class="p">,</span><span class="n">Ewt</span><span class="p">)</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="p">)</span>
<span class="w">   </span><span class="n">exdn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="w">   </span><span class="n">rhdn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.3D0</span><span class="o">*</span><span class="n">ddn</span><span class="o">**</span><span class="n">exdn</span><span class="o">+</span><span class="mf">0.0000013D0</span><span class="p">)</span>
<span class="w">   </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">rhdn</span><span class="p">,</span><span class="mf">1.0D0</span><span class="p">)</span>
<span class="w">   </span><span class="n">iredo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">==</span><span class="n">dls1</span><span class="p">%</span><span class="n">hold</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmin</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">))</span>
<span class="w">   </span><span class="k">else</span>
<span class="k">      </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">hold</span><span class="p">))</span>
<span class="w">      </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">hold</span>
<span class="w">   </span><span class="k">endif</span>
<span class="k">   goto</span><span class="w"> </span><span class="mi">300</span>
<span class="k">else</span>
<span class="k">   if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">jstart</span><span class="o">==-</span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">200</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  On the first call, the order is set to 1, and other variables are</span>
<span class="c">!  initialized.  RMAX is the maximum ratio by which H can be increased</span>
<span class="c">!  in a single step.  It is initially 1.E4 to compensate for the small</span>
<span class="c">!  initial H, but then is normally equal to 10.  If a failure</span>
<span class="c">!  occurs (in corrector convergence or error test), RMAX is set at 2</span>
<span class="c">!  for the next increase.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">lmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">maxord</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">rmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="mf">0.0D0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">el0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">crate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.7D0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">hold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">meo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">meth</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">nslp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span>
<span class="w">   </span><span class="n">iret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  DCFODE is called to get all the integration coefficients for the</span>
<span class="c">!  current METH.  Then the EL vector and related constants are reset</span>
<span class="c">!  whenever the order NQ is changed, or at the start of the problem.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">   </span><span class="k">call </span><span class="n">dcfode</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">meth</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">elco</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">)</span>
<span class="k">endif</span>
<span class="k"> </span><span class="mi">100</span><span class="w">  </span><span class="k">continue</span>
<span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">elco</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span>
<span class="k">enddo</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">nqnyh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="o">*</span><span class="n">Nyh</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">rc</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">el0</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">el0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">conit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5D0</span><span class="o">/</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
<span class="n">dlpk</span><span class="p">%</span><span class="n">epcon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">conit</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span>
<span class="k">select case</span><span class="w"> </span><span class="p">(</span><span class="n">iret</span><span class="p">)</span>
<span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">   </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmin</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">))</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">300</span>
<span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">400</span>
<span class="k">case </span><span class="n">default</span>
<span class="k">endselect</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  If H is being changed, the H ratio RH is checked against</span>
<span class="c">!  RMAX, HMIN, and HMXI, and the YH array rescaled.  IALTH is set to</span>
<span class="c">!  L = NQ + 1 to prevent a change of H for that many steps, unless</span>
<span class="c">!  forced by a convergence or error test failure.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w"> </span><span class="mi">200</span><span class="w">  </span><span class="k">continue</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">==</span><span class="n">dls1</span><span class="p">%</span><span class="n">hold</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">400</span>
<span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">hold</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">hold</span>
<span class="n">iredo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="w"> </span><span class="mi">300</span><span class="w">  </span><span class="k">continue</span>
<span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">rmax</span><span class="p">)</span>
<span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rh</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="mf">1.0D0</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">)</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmxi</span><span class="o">*</span><span class="n">rh</span><span class="p">)</span>
<span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span>
<span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="w">   </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="o">*</span><span class="n">rh</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">      </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">r</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">enddo</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">*</span><span class="n">rh</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">rc</span><span class="o">*</span><span class="n">rh</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">iredo</span><span class="o">==</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">rmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="mf">0.0D0</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">1200</span>
<span class="k">endif</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  This section computes the predicted values by effectively</span>
<span class="c">!  multiplying the YH array by the Pascal triangle matrix.</span>
<span class="c">!  The flag IPUP is set according to whether matrix data is involved</span>
<span class="c">!  (JACFLG .ne. 0) or not (JACFLG = 0), to trigger a call to DPKSET.</span>
<span class="c">!  IPUP is set to MITER when RC differs from 1 by more than CCMAX,</span>
<span class="c">!  and at least every MSBP steps, when JACFLG = 1.</span>
<span class="c">!  RC is the ratio of new to old values of the coefficient  H*EL(1).</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w"> </span><span class="mi">400</span><span class="w">  </span><span class="k">continue</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dlpk</span><span class="p">%</span><span class="n">jacflg</span><span class="o">/=</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">rc</span><span class="o">-</span><span class="mf">1.0D0</span><span class="p">)</span><span class="o">&gt;</span><span class="n">dls1</span><span class="p">%</span><span class="n">ccmax</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nst</span><span class="o">&gt;=</span><span class="n">dls1</span><span class="p">%</span><span class="n">nslp</span><span class="o">+</span><span class="n">dls1</span><span class="p">%</span><span class="n">msbp</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span>
<span class="k">else</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">crate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.7D0</span>
<span class="k">endif</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">tn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">tn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span>
<span class="n">i1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nqnyh</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="k">do </span><span class="n">jb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span>
<span class="w">   </span><span class="n">i1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Nyh</span>
<span class="c">! DIR$ IVDEP</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nqnyh</span>
<span class="w">      </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">Nyh</span><span class="p">)</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">enddo</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  Up to MAXCOR corrector iterations are taken.  A convergence test is</span>
<span class="c">!  made on the RMS-norm of each correction, weighted by the error</span>
<span class="c">!  weight vector EWT.  The sum of the corrections is accumulated in the</span>
<span class="c">!  vector ACOR(i).  The YH array is not altered in the corrector loop.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w"> </span><span class="mi">500</span><span class="w">  </span><span class="k">continue</span>
<span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">dlpk</span><span class="p">%</span><span class="n">mnewt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">   </span><span class="n">Y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="k">enddo</span>
<span class="k">call </span><span class="n">f</span><span class="p">(</span><span class="n">Neq</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">tn</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Savf</span><span class="p">)</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">nfe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nfe</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  If indicated, DPKSET is called to update any matrix data needed,</span>
<span class="c">!  before starting the corrector iteration.</span>
<span class="c">!  IPUP is set to 0 as an indicator that this has been done.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">   </span><span class="k">call </span><span class="n">dpkset</span><span class="p">(</span><span class="n">Neq</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Yh1</span><span class="p">,</span><span class="n">Ewt</span><span class="p">,</span><span class="n">Acor</span><span class="p">,</span><span class="n">Savf</span><span class="p">,</span><span class="n">Wm</span><span class="p">,</span><span class="n">Iwm</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">jac</span><span class="p">)</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">nslp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nst</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">crate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.7D0</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ierpj</span><span class="o">/=</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">800</span>
<span class="k">endif</span>
<span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">   </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="k">enddo</span>
<span class="k"> </span><span class="mi">600</span><span class="w">  </span><span class="k">continue</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span><span class="o">/=</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  In the case of the chord method, compute the corrector error,</span>
<span class="c">!  and solve the linear system with that as right-hand side and</span>
<span class="c">!  P as coefficient matrix.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">      </span><span class="n">Savx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">*</span><span class="n">Savf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">   call </span><span class="n">dsolpk</span><span class="p">(</span><span class="n">Neq</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Savf</span><span class="p">,</span><span class="n">Savx</span><span class="p">,</span><span class="n">Ewt</span><span class="p">,</span><span class="n">Wm</span><span class="p">,</span><span class="n">Iwm</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">psol</span><span class="p">)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">iersl</span><span class="o">&lt;</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">800</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">iersl</span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">700</span>
<span class="w">   </span><span class="n">del</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dvnorm</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span><span class="p">,</span><span class="n">Savx</span><span class="p">,</span><span class="n">Ewt</span><span class="p">)</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">      </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Savx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">      </span><span class="n">Y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">else</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  In the case of functional iteration, update Y directly from</span>
<span class="c">!  the result of the last function evaluation.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">      </span><span class="n">Savf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">*</span><span class="n">Savf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="w">      </span><span class="n">Y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Savf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">   </span><span class="n">del</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dvnorm</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Ewt</span><span class="p">)</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">      </span><span class="n">Y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Savf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">      </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Savf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">endif</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  Test for convergence.  If M .gt. 0, an estimate of the convergence</span>
<span class="c">!  rate constant is stored in CRATE, and this is used in the test.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">m</span><span class="o">/=</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">crate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="mf">0.2D0</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">crate</span><span class="p">,</span><span class="n">del</span><span class="o">/</span><span class="n">delp</span><span class="p">)</span>
<span class="n">dcon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">del</span><span class="o">*</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.0D0</span><span class="p">,</span><span class="mf">1.5D0</span><span class="o">*</span><span class="n">dls1</span><span class="p">%</span><span class="n">crate</span><span class="p">)</span><span class="o">/</span><span class="n">dlpk</span><span class="p">%</span><span class="n">epcon</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dcon</span><span class="o">&lt;=</span><span class="mf">1.0D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  The corrector has converged.  JCUR is set to 0</span>
<span class="c">!  to signal that the Jacobian involved may need updating later.</span>
<span class="c">!  The local error test is made and control passes to statement 500</span>
<span class="c">!  if it fails.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">jcur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">m</span><span class="o">==</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">dsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">del</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">m</span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">dsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dvnorm</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span><span class="p">,</span><span class="n">Acor</span><span class="p">,</span><span class="n">Ewt</span><span class="p">)</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dsm</span><span class="o">&gt;</span><span class="mf">1.0D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  The error test failed.  KFLAG keeps track of multiple failures.</span>
<span class="c">!  Restore TN and the YH array to their previous values, and prepare</span>
<span class="c">!  to try the step again.  Compute the optimum step size for this or</span>
<span class="c">!  one lower order.  After 2 or more failures, H is forced to decrease</span>
<span class="c">!  by a factor of 0.2 or less.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">      </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="n">dls1</span><span class="p">%</span><span class="n">tn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">told</span>
<span class="w">      </span><span class="n">i1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nqnyh</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="k">do </span><span class="n">jb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span>
<span class="w">         </span><span class="n">i1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Nyh</span>
<span class="c">! DIR$ IVDEP</span>
<span class="w">         </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nqnyh</span>
<span class="w">            </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">Nyh</span><span class="p">)</span>
<span class="w">         </span><span class="k">enddo</span>
<span class="k">      enddo</span>
<span class="k">      </span><span class="n">dls1</span><span class="p">%</span><span class="n">rmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0D0</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmin</span><span class="o">*</span><span class="mf">1.00001D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  All returns are made through this section.  H is saved in HOLD</span>
<span class="c">!  to allow the caller to change H on the next step.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">         </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">         </span><span class="k">goto</span><span class="w"> </span><span class="mi">1300</span>
<span class="w">      </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="o">&lt;=-</span><span class="mi">3</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  Control reaches this section if 3 or more failures have occured.</span>
<span class="c">!  If 10 failures have occurred, exit with KFLAG = -1.</span>
<span class="c">!  It is assumed that the derivatives that have accumulated in the</span>
<span class="c">!  YH array have errors of the wrong order.  Hence the first</span>
<span class="c">!  derivative is recomputed, and the order is set to 1.  Then</span>
<span class="c">!  H is reduced by a factor of 10, and the step is retried,</span>
<span class="c">!  until it succeeds or H reaches HMIN.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="o">==-</span><span class="mi">10</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="mi">1300</span>
<span class="w">         </span><span class="k">else</span>
<span class="k">            </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1D0</span>
<span class="w">            </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmin</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">),</span><span class="n">rh</span><span class="p">)</span>
<span class="w">            </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">*</span><span class="n">rh</span>
<span class="w">            </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">               </span><span class="n">Y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="k">enddo</span>
<span class="k">            call </span><span class="n">f</span><span class="p">(</span><span class="n">Neq</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">tn</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Savf</span><span class="p">)</span>
<span class="w">            </span><span class="n">dls1</span><span class="p">%</span><span class="n">nfe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nfe</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">               </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="o">*</span><span class="n">Savf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">            </span><span class="k">enddo</span>
<span class="k">            </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span>
<span class="w">            </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="mi">400</span>
<span class="w">            </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">            </span><span class="n">iret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="mi">100</span>
<span class="w">         </span><span class="k">endif</span>
<span class="k">      else</span>
<span class="k">         </span><span class="n">iredo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">         </span><span class="n">rhup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="w">         </span><span class="k">goto</span><span class="w"> </span><span class="mi">900</span>
<span class="w">      </span><span class="k">endif</span>
<span class="k">   else</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  After a successful step, update the YH array.</span>
<span class="c">!  Consider changing H if IALTH = 1.  Otherwise decrease IALTH by 1.</span>
<span class="c">!  If IALTH is then 1 and NQ .lt. MAXORD, then ACOR is saved for</span>
<span class="c">!  use in a possible order increase on the next step.</span>
<span class="c">!  If a change in H is considered, an increase or decrease in order</span>
<span class="c">!  by one is considered also.  A change in H is made only if it is by a</span>
<span class="c">!  factor of at least 1.1.  If not, IALTH is set to 3 to prevent</span>
<span class="c">!  testing for that many steps.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">      </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="n">iredo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="n">dls1</span><span class="p">%</span><span class="n">nst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nst</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="n">dls1</span><span class="p">%</span><span class="n">hu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span>
<span class="w">      </span><span class="n">dls1</span><span class="p">%</span><span class="n">nqu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span>
<span class="w">      </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="w">         </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">            </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">         </span><span class="k">enddo</span>
<span class="k">      enddo</span>
<span class="k">      </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="o">==</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  Regardless of the success or failure of the step, factors</span>
<span class="c">!  RHDN, RHSM, and RHUP are computed, by which H could be multiplied</span>
<span class="c">!  at order NQ - 1, order NQ, or order NQ + 1, respectively.</span>
<span class="c">!  In the case of failure, RHUP = 0.0 to avoid an order increase.</span>
<span class="c">!  the largest of these is determined and the new order chosen</span>
<span class="c">!  accordingly.  If the order is to be increased, we compute one</span>
<span class="c">!  additional scaled derivative.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">         </span><span class="n">rhup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="o">/=</span><span class="n">dls1</span><span class="p">%</span><span class="n">lmax</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">               </span><span class="n">Savf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">lmax</span><span class="p">)</span>
<span class="w">            </span><span class="k">enddo</span>
<span class="k">            </span><span class="n">dup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dvnorm</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span><span class="p">,</span><span class="n">Savf</span><span class="p">,</span><span class="n">Ewt</span><span class="p">)</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span>
<span class="w">            </span><span class="n">exup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="n">rhup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.4D0</span><span class="o">*</span><span class="n">dup</span><span class="o">**</span><span class="n">exup</span><span class="o">+</span><span class="mf">0.0000014D0</span><span class="p">)</span>
<span class="w">         </span><span class="k">endif</span>
<span class="k">         goto</span><span class="w"> </span><span class="mi">900</span>
<span class="w">      </span><span class="k">else</span>
<span class="k">         if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="o">&lt;=</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="o">/=</span><span class="n">dls1</span><span class="p">%</span><span class="n">lmax</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">               do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">                  </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">lmax</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">               </span><span class="k">enddo</span>
<span class="k">            endif</span>
<span class="k">         endif</span>
<span class="k">         goto</span><span class="w"> </span><span class="mi">1200</span>
<span class="w">      </span><span class="k">endif</span>
<span class="k">   endif</span>
<span class="k">else</span>
<span class="k">   </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">m</span><span class="o">/=</span><span class="n">dls1</span><span class="p">%</span><span class="n">maxcor</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">m</span><span class="o">&lt;</span><span class="mi">2</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">del</span><span class="o">&lt;=</span><span class="mf">2.0D0</span><span class="o">*</span><span class="n">delp</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         </span><span class="n">dlpk</span><span class="p">%</span><span class="n">mnewt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span>
<span class="w">         </span><span class="n">delp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">del</span>
<span class="w">         </span><span class="k">call </span><span class="n">f</span><span class="p">(</span><span class="n">Neq</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">tn</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Savf</span><span class="p">)</span>
<span class="w">         </span><span class="n">dls1</span><span class="p">%</span><span class="n">nfe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nfe</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="k">goto</span><span class="w"> </span><span class="mi">600</span>
<span class="w">      </span><span class="k">endif</span>
<span class="k">   endif</span>
<span class="k">endif</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  The corrector iteration failed to converge.</span>
<span class="c">!  If MITER .ne. 0 and the Jacobian is out of date, DPKSET is called for</span>
<span class="c">!  the next try.  Otherwise the YH array is retracted to its values</span>
<span class="c">!  before prediction, and H is reduced, if possible.  If H cannot be</span>
<span class="c">!  reduced or MXNCF failures have occurred, exit with KFLAG = -2.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w"> </span><span class="mi">700</span><span class="w">  </span><span class="k">continue</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span><span class="o">/=</span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">jcur</span><span class="o">/=</span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">dlpk</span><span class="p">%</span><span class="n">jacflg</span><span class="o">/=</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">icf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">500</span>
<span class="k">endif</span>
<span class="k"> </span><span class="mi">800</span><span class="w">  </span><span class="k">continue</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">icf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="n">ncf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="n">dlpk</span><span class="p">%</span><span class="n">ncfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlpk</span><span class="p">%</span><span class="n">ncfn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">rmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0D0</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">tn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">told</span>
<span class="n">i1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nqnyh</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="k">do </span><span class="n">jb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span>
<span class="w">   </span><span class="n">i1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Nyh</span>
<span class="c">! DIR$ IVDEP</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nqnyh</span>
<span class="w">      </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Yh1</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">Nyh</span><span class="p">)</span>
<span class="w">   </span><span class="k">enddo</span>
<span class="k">enddo</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">ierpj</span><span class="o">&lt;</span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">iersl</span><span class="o">&lt;</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">3</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">1300</span>
<span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmin</span><span class="o">*</span><span class="mf">1.00001D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">1300</span>
<span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ncf</span><span class="o">==</span><span class="n">dls1</span><span class="p">%</span><span class="n">mxncf</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">1300</span>
<span class="k">else</span>
<span class="k">   </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5D0</span>
<span class="w">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ipup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">miter</span>
<span class="w">   </span><span class="n">iredo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmin</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">))</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">300</span>
<span class="k">endif</span>
<span class="k"> </span><span class="mi">900</span><span class="w">  </span><span class="k">continue</span>
<span class="n">exsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="n">rhsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.2D0</span><span class="o">*</span><span class="n">dsm</span><span class="o">**</span><span class="n">exsm</span><span class="o">+</span><span class="mf">0.0000012D0</span><span class="p">)</span>
<span class="n">rhdn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="o">/=</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">ddn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dvnorm</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span><span class="p">,</span><span class="n">Yh</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="p">),</span><span class="n">Ewt</span><span class="p">)</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="p">)</span>
<span class="w">   </span><span class="n">exdn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span>
<span class="w">   </span><span class="n">rhdn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.3D0</span><span class="o">*</span><span class="n">ddn</span><span class="o">**</span><span class="n">exdn</span><span class="o">+</span><span class="mf">0.0000013D0</span><span class="p">)</span>
<span class="k">endif</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">rhsm</span><span class="o">&gt;=</span><span class="n">rhup</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">rhsm</span><span class="o">&gt;=</span><span class="n">rhdn</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">newq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span>
<span class="w">      </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rhsm</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">   </span><span class="k">endif</span>
<span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">rhup</span><span class="o">&gt;</span><span class="n">rhdn</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">newq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="w">   </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rhup</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">rh</span><span class="o">&lt;</span><span class="mf">1.1D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="mi">1200</span>
<span class="w">   </span><span class="k">else</span>
<span class="k">      </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">el</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="p">)</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">l</span>
<span class="w">      </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">         </span><span class="n">Yh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">newq</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">r</span>
<span class="w">      </span><span class="k">enddo</span>
<span class="k">      goto</span><span class="w"> </span><span class="mi">1100</span>
<span class="w">   </span><span class="k">endif</span>
<span class="k">endif</span>
<span class="n">newq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rhdn</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="o">&lt;</span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">rh</span><span class="o">&gt;</span><span class="mf">1.0D0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span>
<span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="k">continue</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">rh</span><span class="o">&lt;</span><span class="mf">1.1D0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">dls1</span><span class="p">%</span><span class="n">ialth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span><span class="mi">1200</span>
<span class="k">else</span>
<span class="k">   if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">kflag</span><span class="o">&lt;=-</span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="mf">0.2D0</span><span class="p">)</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">!  If there is a change of order, reset NQ, L, and the coefficients.</span>
<span class="c">!  In any case H is reset according to RH and the YH array is rescaled.</span>
<span class="c">!  Then exit from 690 if the step was OK, or redo the step otherwise.</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">newq</span><span class="o">==</span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">rh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">hmin</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span><span class="p">))</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="mi">300</span>
<span class="w">   </span><span class="k">endif</span>
<span class="k">endif</span>
<span class="k"> </span><span class="mi">1100</span><span class="w"> </span><span class="k">continue</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newq</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">nq</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="n">iret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="k">goto</span><span class="w"> </span><span class="mi">100</span>

<span class="w"> </span><span class="mi">1200</span><span class="w"> </span><span class="k">continue</span>
<span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span><span class="o">/</span><span class="n">dls1</span><span class="p">%</span><span class="n">tesco</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">dls1</span><span class="p">%</span><span class="n">nqu</span><span class="p">)</span>
<span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">n</span>
<span class="w">   </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Acor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">r</span>
<span class="k">enddo</span>
<span class="k"> </span><span class="mi">1300</span><span class="w"> </span><span class="k">continue</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">hold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dls1</span><span class="p">%</span><span class="n">h</span>
<span class="n">dls1</span><span class="p">%</span><span class="n">jstart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="k">end subroutine </span><span class="n">dstodpk</span>
</pre></div>

    </section>
    <br>
    
    </div>
  </div>

      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row justify-content-between">
          <div class="col"><p>odepack was developed by Alan C. Hindmarsh as modified by John S. Urban, Jacob Williams<br>&copy; 2024 
</p>
          </div>
          <div class="col">
            <p class="text-end">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
 on 2024-03-29 08:21              </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>    

    <!-- MathJax JavaScript
             ================================================== -->
             <!-- Placed at the end of the document so the pages load faster -->
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
          TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
          jax: ['input/TeX','input/MathML','output/HTML-CSS'],
          extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
          });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

          <script src="../tipuesearch/tipuesearch_content.js"></script>
          <script src="../tipuesearch/tipuesearch_set.js"></script>
          <script src="../tipuesearch/tipuesearch.js"></script>

  </body>
</html>